<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多人協作點名系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .stat-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .class-header {
            background: linear-gradient(45deg, #2193b0, #6dd5ed);
            color: white;
            border-radius: 10px 10px 0 0;
            padding: 15px;
            font-weight: bold;
        }

        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .custom-status-tag {
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
        }

        .nav-pills .nav-link {
            border-radius: 20px;
            margin-right: 5px;
            color: #555;
            background: #fff;
            border: 1px solid #ddd;
            word-break: keep-all;
        }

        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .nav-scroller {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 10px;
        }

        @media (max-width: 768px) {
            .class-header {
                border-radius: 12px 12px 0 0;
            }

            /* Table styles removed to match desktop view */
        }

        /* New Scroll Container for Mobile Tabs */
        .scroll-container {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 5px;
            margin-bottom: 10px;
            gap: 8px;
        }

        .scroll-container::-webkit-scrollbar {
            height: 4px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }

        /* Header Optimization */
        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 576px) {
            .header-top {
                flex-direction: column;
                align-items: flex-start !important;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }

            .header-actions .btn-group,
            .header-actions .btn {
                flex: 1;
            }
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-3" style="max-width: 800px;">
        <!-- Top Bar -->
        <div class="d-flex justify-content-between align-items-center mb-3 header-top">
            <h2 class="fw-bold text-primary m-0 d-flex align-items-center">
                <i class="bi bi-pencil-square me-2"></i>點名系統
            </h2>
            <div class="header-actions">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="groupBy" id="groupByClass" value="class" checked
                        onchange="setGroupBy('class')">
                    <label class="btn btn-outline-primary" for="groupByClass">依班級</label>
                    <input type="radio" class="btn-check" name="groupBy" id="groupByGroup" value="group"
                        onchange="setGroupBy('group')">
                    <label class="btn btn-outline-primary" for="groupByGroup">依組別</label>
                </div>
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                    <i class="bi bi-person-plus-fill"></i> <span class="d-none d-sm-inline">新增</span>
                </button>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                    <i class="bi bi-gear-fill"></i>
                </button>
            </div>
        </div>

        <!-- Week Tabs (Scrollable) -->
        <div id="weekTabs" class="scroll-container mb-3">
            <!-- JS Generated -->
        </div>

        <!-- Session Tabs (Scrollable) -->
        <div id="sessionTabs" class="scroll-container mb-3">
            <!-- JS Generated -->
        </div>

        <!-- Search Bar -->
        <div class="row mb-3 gx-2 align-items-center">
            <div class="col">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="search" id="searchInput" class="form-control border-start-0" placeholder="搜尋學生姓名..."
                        oninput="filterStudents()">
                </div>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-12">
                <div class="stat-card border-start border-5 border-primary">
                    <div class="row mb-3 align-items-center">
                        <div class="col-12">
                            <h5 class="mb-0 d-flex align-items-center flex-wrap">
                                總覽 <small class="text-muted mx-2" id="currentSessionLabel"></small>
                                <button class="btn btn-outline-primary btn-sm ms-auto" onclick="copyGlobalReport()">
                                    <i class="bi bi-clipboard"></i> 複製總覽
                                </button>
                            </h5>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-4 align-items-center" id="globalStatsPanel">
                        <span class="spinner-border spinner-border-sm" role="status"></span> 載入統計中...
                    </div>
                </div>
            </div>
        </div>



        <div id="classContainer" class="row g-4">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">連線中...</p>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增人員</h5>
                    <button type="button" class="btn-primary btn-sm ms-auto me-2 btn" data-bs-toggle="modal"
                        data-bs-target="#batchAddModal">批量新增</button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="form-floating"><input type="text" id="inputClass" class="form-control"
                                    placeholder="班級"><label for="inputClass">班級 (例: 101)</label></div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating"><input type="text" id="inputGroup" class="form-control"
                                    placeholder="組別"><label for="inputGroup">組別 (例: A組)</label></div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating"><input type="text" id="inputName" class="form-control"
                                    placeholder="姓名"><label for="inputName">姓名</label></div>
                        </div>
                        <div class="col-12 text-end">
                            <button onclick="addStudent()" class="btn btn-primary btn-lg w-100 shadow-sm"><i
                                    class="bi bi-plus-lg"></i> 確定新增</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">差勤狀態設定</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3"><input type="text" id="newStatusInput" class="form-control"
                            placeholder="輸入新狀態名稱"><button class="btn btn-primary"
                            onclick="addNewStatusType()">新增</button></div>
                    <hr>
                    <h6>目前可用狀態:</h6>
                    <div id="statusListContainer" class="d-flex flex-wrap"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="batchAddModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量新增學生</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small">格式：<strong>班級 組別 姓名</strong> (中間空白)<br>範例：<br>101 A組 王小明</div>
                    <textarea id="batchInput" class="form-control" rows="10" placeholder="101 A組 王小明"></textarea>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">取消</button><button type="button" class="btn btn-primary"
                        onclick="batchAddStudents()">開始匯入</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyACL_67nXJU6RZEf3InFqHQJ-5h6FMZ7t8",
            authDomain: "check-74ee8.firebaseapp.com",
            projectId: "check-74ee8",
            storageBucket: "check-74ee8.firebasestorage.app",
            messagingSenderId: "795590503656",
            appId: "1:795590503656:web:f68019efd5eb88aa51ed5d",
            measurementId: "G-QMBN11NQ34"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const studentsRef = collection(db, "students");
        const configRef = doc(db, "settings", "globalConfig");

        const sessions = ["早點名", "早上上餐廳", "0740集合", "中午上餐廳", "1320集合", "晚上上餐廳", "晚自習", "晚點名", "備用點名"];
        const days = ["星期一", "星期二", "星期三", "星期四", "星期五", "星期六", "星期日"];

        let currentSession = sessions[0];
        let currentDay = days[0];
        let currentGroupMode = "class";
        let currentStatuses = ["實到", "遲到", "缺席"];
        let studentsData = [];

        // 初始化
        initWeekTabs();
        initSessionTabs();

        // 功能: 複製
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => alert("已複製到剪貼簿！"))
                    .catch(err => fallbackCopyTextToClipboard(text));
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                var successful = document.execCommand('copy');
                var msg = successful ? '已複製到剪貼簿！' : '複製失敗';
                alert(msg);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                alert("複製失敗 (瀏覽器不支援)");
            }
            document.body.removeChild(textArea);
        }

        function getStatusKey(session) {
            return `${currentDay}_${session}`;
        }

        function generateReportText(scope, groupName = null, specifiedSession = null) {
            let output = "";
            const targetSessions = specifiedSession ? [specifiedSession] : sessions;

            if (scope === 'all') {
                targetSessions.forEach(session => {
                    const statusKey = getStatusKey(session);
                    const stats = { '實到': 0 };
                    const detailList = {};
                    currentStatuses.forEach(s => { if (s !== '實到') detailList[s] = []; });
                    let total = 0;

                    studentsData.forEach(s => {
                        total++;
                        const status = (s.status && s.status[statusKey]) ? s.status[statusKey] : '實到';
                        if (status === '實到') stats['實到']++;
                        else {
                            if (!detailList[status]) detailList[status] = [];
                            detailList[status].push(s.name);
                        }
                    });

                    output += `應到:${total}\n`;
                    output += `事故：\n`;
                    Object.entries(detailList).forEach(([status, names]) => {
                        if (names.length > 0) {
                            output += `${status}${names.length} ${names.join(' ')}\n`;
                        }
                    });
                    output += `實到：${stats['實到']}\n\n`;
                });
                return output;
            }

            let targetGroups = [groupName];
            targetGroups.forEach(gName => {
                output += `${gName}\n\n`;
                targetSessions.forEach(session => {
                    const groupStudents = studentsData.filter(s => {
                        const sGroup = currentGroupMode === 'class' ? s.class : (s.group || '未分組');
                        return sGroup === gName;
                    });
                    if (groupStudents.length === 0) return;
                    const total = groupStudents.length;
                    const statusKey = getStatusKey(session);
                    const stats = { '實到': 0 };
                    const detailList = {};
                    currentStatuses.forEach(s => { if (s !== '實到') detailList[s] = []; });

                    groupStudents.forEach(s => {
                        const status = (s.status && s.status[statusKey]) ? s.status[statusKey] : '實到';
                        if (status === '實到') stats['實到']++;
                        else {
                            if (!detailList[status]) detailList[status] = [];
                            detailList[status].push(s.name);
                        }
                    });

                    output += `${session}\n應到${total}\n事故：\n`;
                    Object.entries(detailList).forEach(([status, names]) => {
                        if (names.length > 0) output += `${status}${names.length} ${names.join(' ')}\n`;
                    });
                    output += `實到：${stats['實到']}\n\n`;
                });
                output += `------------------\n\n`;
            });
            return output;
        }

        onSnapshot(configRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                if (data.statuses && Array.isArray(data.statuses)) {
                    currentStatuses = data.statuses;
                    renderStatusSettings();
                    renderAll();
                }
            } else {
                setDoc(configRef, { statuses: ["實到", "遲到", "缺席", "病假", "事假", "公假"] });
            }
        });

        const q = query(studentsRef);
        onSnapshot(q, (snapshot) => {
            studentsData = [];
            snapshot.forEach((doc) => studentsData.push({ id: doc.id, ...doc.data() }));
            studentsData.sort((a, b) => {
                if (a.class !== b.class) return a.class.localeCompare(b.class);
                return (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0);
            });
            try { renderAll(); } catch (err) { console.error(err); }
        });

        function initWeekTabs() {
            const container = document.getElementById('weekTabs');
            container.innerHTML = days.map(d => `
                <button class="btn ${currentDay === d ? 'btn-primary' : 'btn-outline-secondary'} rounded-pill text-nowrap px-4" 
                        onclick="changeDay('${d}')">${d}</button>
            `).join('');
        }

        function initSessionTabs() {
            const container = document.getElementById('sessionTabs');
            container.innerHTML = sessions.map(s => `
                <button class="btn ${currentSession === s ? 'btn-primary' : 'btn-white bg-white border'} rounded-pill text-nowrap px-3 shadow-sm" 
                        onclick="changeSession('${s}')">${s}</button>
            `).join('');
        }

        function renderAll() {
            const container = document.getElementById('classContainer');
            const globalStatsPanel = document.getElementById('globalStatsPanel');
            document.getElementById('currentSessionLabel').innerText = `(${currentDay} - ${currentSession})`;
            container.innerHTML = ""; globalStatsPanel.innerHTML = "";

            const grouped = {};
            const globalStats = { total: 0, byStatus: {}, byStatusNames: {} };
            currentStatuses.forEach(s => {
                globalStats.byStatus[s] = 0;
                globalStats.byStatusNames[s] = [];
            });

            studentsData.forEach(student => {
                let key = currentGroupMode === 'class' ? student.class : student.group;
                if (!key) key = "未分組";
                if (!grouped[key]) {
                    // Initialize group stats with names array
                    grouped[key] = { students: [], stats: { total: 0, byStatus: {}, byStatusNames: {} } };
                    currentStatuses.forEach(s => {
                        grouped[key].stats.byStatus[s] = 0;
                        grouped[key].stats.byStatusNames[s] = [];
                    });
                }
                grouped[key].students.push(student);

                // Use Composite Key
                const statusKey = getStatusKey(currentSession);
                let status = "實到";
                if (student.status && student.status[statusKey]) status = student.status[statusKey];
                student._currentStatus = status;

                grouped[key].stats.total++;
                if (grouped[key].stats.byStatus[status] !== undefined) {
                    grouped[key].stats.byStatus[status]++;
                    grouped[key].stats.byStatusNames[status].push(student.name);
                }

                globalStats.total++;
                if (globalStats.byStatus[status] !== undefined) {
                    globalStats.byStatus[status]++;
                    globalStats.byStatusNames[status].push(student.name);
                }
            });

            // Global Stats
            let globalStatsHtml = `
                <div class="d-flex align-items-center me-4 mb-2">
                    <span class="text-muted small me-2">應到</span>
                    <span class="fs-4 fw-bold text-dark">${globalStats.total}</span>
                </div>
                <div class="d-flex align-items-center me-4 mb-2">
                    <span class="text-muted small me-2">實到</span>
                    <span class="fs-4 fw-bold text-success">${globalStats.byStatus['實到'] || 0}</span>
                </div>
            `;

            let breakdownHtml = "";
            Object.entries(globalStats.byStatusNames).forEach(([status, names]) => {
                if (status !== '實到' && names.length > 0) {
                    breakdownHtml += `
                        <div class="mb-1">
                            <span class="badge bg-light text-danger border border-danger me-1">${status} (${names.length})</span>
                            <span class="small text-secondary">${names.join(', ')}</span>
                        </div>
                    `;
                }
            });

            if (breakdownHtml) {
                globalStatsHtml += `<div class="d-flex flex-column border-start ps-3 ms-2">${breakdownHtml}</div>`;
            } else {
                globalStatsHtml += `<div class="d-flex flex-column border-start ps-3 ms-2"><span class="text-muted small">全員實到</span></div>`;
            }

            globalStatsPanel.innerHTML = globalStatsHtml;

            if (Object.keys(grouped).length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted py-5">目前沒有資料，請從上方新增。</div>`;
                return;
            }

            Object.keys(grouped).sort().forEach(groupName => {
                const group = grouped[groupName];
                let classStatStr = `應到: ${group.stats.total} | 實到: ${group.stats.byStatus['實到'] || 0}`;

                // Generate class detail string
                let classDetailHtml = "";
                Object.entries(group.stats.byStatusNames).forEach(([status, names]) => {
                    if (status !== '實到' && names.length > 0) {
                        classDetailHtml += `<div class="text-end" style="font-size: 0.85rem;">${status}: ${names.length} (${names.join(' ')})</div>`;
                    }
                });

                const rows = group.students.map(student => `
                    <tr>
                        <td><span class="fw-bold ${getNameColorClass(student._currentStatus)}">${student.name}</span><br><span class="badge bg-light text-secondary border">${student.class} / ${student.group || '-'}</span></td>
                        <td>${getStatusBadge(student._currentStatus)}</td>
                        <td>
                            <select class="form-select form-select-sm fw-bold ${getStatusColorClass(student._currentStatus)}" onchange="updateStatus('${student.id}', this.value)" style="min-width: 110px;">
                                ${currentStatuses.map(s => `<option value="${s}" ${student._currentStatus === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </td>
                        <td class="text-end"><button class="btn btn-sm btn-light text-danger" onclick="removeStudent('${student.id}')"><i class="bi bi-trash"></i></button></td>
                    </tr>
                `).join('');

                const card = `
                    <div class="col-xl-6 col-12">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="class-header d-flex justify-content-between align-items-start">
                                <div class="d-flex align-items-center mt-1">
                                    <span class="fs-5 me-2"><i class="bi bi-house-door-fill me-2"></i>${groupName}</span>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-link text-white p-0" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="copyToClipboard(generateReportText('group', '${groupName}', '${currentSession}'))">複製本班 (當下時段)</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="copyToClipboard(generateReportText('group', '${groupName}', null))">複製本班 (全部時段)</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="d-flex flex-column align-items-end">
                                    <span class="badge bg-light text-dark opacity-75 fw-normal fs-6 mb-1">${classStatStr}</span>
                                    <div class="text-white opacity-90">${classDetailHtml}</div>
                                </div>
                            </div>
                            <div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th style="width: 25%">姓名</th><th style="width: 15%">狀態</th><th>操作</th><th style="width: 10%"></th></tr></thead><tbody>${rows}</tbody></table></div></div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });

            // Re-apply search filter if exists
            if (document.getElementById('searchInput').value.trim()) {
                filterStudents();
            }
        }

        window.changeDay = (day) => { currentDay = day; initWeekTabs(); renderAll(); };
        window.changeSession = (n) => { currentSession = n; initSessionTabs(); renderAll(); };
        window.setGroupBy = (m) => { currentGroupMode = m; renderAll(); };
        window.addStudent = async () => {
            const classInput = document.getElementById('inputClass').value.trim();
            const groupInput = document.getElementById('inputGroup').value.trim();
            const nameInput = document.getElementById('inputName').value.trim();
            if (!classInput || !nameInput) return alert("請輸入班級和姓名");
            try {
                await addDoc(studentsRef, { class: classInput, group: groupInput || "無", name: nameInput, status: {}, timestamp: new Date() });
                document.getElementById('inputName').value = '';
            } catch (e) { console.error(e); alert("新增失敗"); }
        };
        window.batchAddStudents = async () => {
            const input = document.getElementById('batchInput').value.trim();
            if (!input) return;
            const lines = input.split('\n');
            const promises = [];
            for (let line of lines) {
                line = line.trim();
                const parts = line.split(/\s+/);
                if (parts.length < 3) continue;
                promises.push(addDoc(studentsRef, { class: parts[0], group: parts[1], name: parts.slice(2).join(' '), status: {}, timestamp: new Date() }));
            }
            try {
                await Promise.all(promises);
                alert("匯入成功！");
                bootstrap.Modal.getOrCreateInstance(document.getElementById('batchAddModal')).hide();
                document.getElementById('batchInput').value = '';
            } catch (e) { console.error(e); alert("匯入失敗"); }
        };
        window.updateStatus = async (id, val) => {
            const statusKey = getStatusKey(currentSession);
            await updateDoc(doc(db, "students", id), { [`status.${statusKey}`]: val });
        };
        window.removeStudent = async (id) => { if (confirm('確定刪除？')) await deleteDoc(doc(db, "students", id)); };
        window.addNewStatusType = async () => {
            const val = document.getElementById('newStatusInput').value.trim();
            if (!val || currentStatuses.includes(val)) return;
            await updateDoc(configRef, { statuses: [...currentStatuses, val] });
            document.getElementById('newStatusInput').value = '';
        };
        window.removeStatusType = async (val) => {
            if (confirm(`移除 ${val}?`)) await updateDoc(configRef, { statuses: currentStatuses.filter(s => s !== val) });
        };
        // Export locally defined functions to global scope
        window.copyToClipboard = copyToClipboard;
        window.generateReportText = generateReportText;
        window.filterStudents = filterStudents;
        window.copyGlobalReport = () => copyToClipboard(generateReportText('all', null, currentSession));

        // Note: other functions like addStudent, removeStudent are already assigned to window directly above.

        function setGroupBy(mode) {
            currentGroupMode = mode;
            renderAll();
        }

        function getStatusBadge(s) {
            if (s === '實到') return '<span class="badge bg-success">實到</span>';
            if (s === '缺席') return '<span class="badge bg-danger">缺席</span>';
            if (s === '遲到') return '<span class="badge bg-warning text-dark">遲到</span>';
            return `<span class="badge bg-info text-dark">${s}</span>`;
        }
        function filterStudents() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            const cards = document.querySelectorAll('.card'); // Each group/class is in a card

            cards.forEach(card => {
                const rows = card.querySelectorAll('tbody tr');
                let hasVisibleStudent = false;

                rows.forEach(row => {
                    // Check all text in the row (Name, Class, Group, etc.)
                    // This is simpler and robust for both mobile and desktop views
                    if (row.textContent.toLowerCase().includes(query)) {
                        row.style.display = ""; // Reset to default (table-row or grid)
                        hasVisibleStudent = true;
                    } else {
                        row.style.setProperty('display', 'none', 'important'); // Force hide
                    }
                });

                // If searching, hide empty groups.
                if (hasVisibleStudent) {
                    card.parentElement.style.display = "";
                } else {
                    card.parentElement.style.display = "none";
                }
            });
        }

        function getStatusColorClass(s) {
            if (!s || s === '實到') return "text-success border-success bg-white";
            if (s === '缺席') return "text-danger border-danger bg-white";
            if (s === '遲到') return "text-warning border-warning bg-white";
            return "text-secondary border-secondary bg-white";
        }
        function getNameColorClass(s) {
            if (!s || s === '實到') return "text-primary";
            return "text-danger fw-bolder";
        }
        function renderStatusSettings() {
            document.getElementById('statusListContainer').innerHTML = currentStatuses.map(s => `
                <div class="custom-status-tag border rounded px-2 py-1 bg-light">${s} ${s !== '實到' ? `<span role="button" class="text-danger ms-2 fw-bold" onclick="removeStatusType('${s}')">&times;</span>` : ''}</div>
            `).join('');
        }

        // Enable Drag to Scroll & Wheel to Scroll
        function enableDragScroll(id) {
            const slider = document.getElementById(id);
            let isDown = false;
            let startX;
            let scrollLeft;

            slider.addEventListener('mousedown', (e) => {
                isDown = true;
                slider.classList.add('active');
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });
            slider.addEventListener('mouseleave', () => {
                isDown = false;
                slider.classList.remove('active');
            });
            slider.addEventListener('mouseup', () => {
                isDown = false;
                slider.classList.remove('active');
            });
            slider.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 2; // Scroll-fast
                slider.scrollLeft = scrollLeft - walk;
            });
            // Convert vertical wheel to horizontal scroll
            slider.addEventListener('wheel', (e) => {
                if (e.deltaY !== 0) {
                    e.preventDefault();
                    slider.scrollLeft += e.deltaY;
                }
            });
        }

        // Initialize scroll features
        enableDragScroll('weekTabs');
        enableDragScroll('sessionTabs');
    </script>
</body>

</html>