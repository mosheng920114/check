<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>點名系統 v1.2</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .stat-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .class-header {
            background: linear-gradient(45deg, #2193b0, #6dd5ed);
            color: white;
            border-radius: 10px 10px 0 0;
            padding: 15px;
            font-weight: bold;
        }

        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .custom-status-tag {
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
        }

        .nav-pills .nav-link {
            border-radius: 20px;
            margin-right: 5px;
            color: #555;
            background: #fff;
            border: 1px solid #ddd;
            word-break: keep-all;
        }

        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .nav-scroller {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 10px;
        }

        @media (max-width: 768px) {
            .class-header {
                border-radius: 12px 12px 0 0;
            }

            /* Table styles removed to match desktop view */
        }

        /* New Scroll Container for Mobile Tabs */
        .scroll-container {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 5px;
            margin-bottom: 10px;
            gap: 8px;
        }

        .scroll-container::-webkit-scrollbar {
            height: 4px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }

        /* Header Optimization */
        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 576px) {
            .header-top {
                flex-direction: column;
                align-items: flex-start !important;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }

            .header-actions .btn-group,
            .header-actions .btn {
                flex: 1;
            }
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-3" style="max-width: 1000px;">
        <!-- Top Bar -->
        <div class="d-flex justify-content-between align-items-center mb-3 header-top">
            <h2 class="fw-bold text-primary m-0 d-flex align-items-center">
                <i class="bi bi-pencil-square me-2"></i>點名系統
            </h2>
            <div class="header-actions">
                <!-- Right Side: Settings & Add -->
                <div class="d-flex align-items-center flex-wrap">
                    <button id="adminLoginBtn" class="btn btn-outline-primary me-1 me-md-2" onclick="showAdminLogin()"
                        title="管理員登入">
                        <i class="bi bi-key-fill"></i>
                    </button>
                    <div id="userInfoDisplay" class="d-none align-items-center me-1 me-md-2">
                        <!-- Notification Bell (Hidden by default) -->
                        <button id="notificationBtn" class="btn btn-outline-warning position-relative me-2 d-none"
                            onclick="showApprovalModal()">
                            <i class="bi bi-bell-fill"></i>
                            <span id="notificationBadge"
                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                                0
                                <span class="visually-hidden">unread messages</span>
                            </span>
                        </button>

                        <!-- User Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle fw-bold" type="button"
                                id="userMenuBtn" data-bs-toggle="dropdown">
                                <span id="userNameDisplay"></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal"
                                        data-bs-target="#changePasswordModal"><i class="bi bi-key me-2"></i>更改密碼</a>
                                </li>
                                <li><a class="dropdown-item d-none" id="adminManageLink" href="#"
                                        onclick="showAdminDashboard()"><i class="bi bi-people-fill me-2"></i>人員權限管理</a>
                                </li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i
                                            class="bi bi-box-arrow-right me-2"></i>登出</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="btn-group me-1 me-md-2" role="group">
                        <button class="btn btn-outline-primary px-2 px-md-3 text-nowrap"
                            onclick="setGroupBy('class')">依班級</button>
                        <button class="btn btn-outline-primary px-2 px-md-3 text-nowrap"
                            onclick="setGroupBy('group')">依組別</button>
                    </div>

                    <button id="addStudentBtn" class="btn btn-outline-primary me-1 me-md-2"
                        onclick="showAddStudentModal()">
                        <i class="bi bi-person-plus-fill me-1"></i><span class="d-none d-sm-inline">新增</span>
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                        <i class="bi bi-gear-fill"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Week Tabs (Scrollable) -->
        <div id="weekTabs" class="scroll-container mb-3">
            <!-- JS Generated -->
        </div>

        <!-- Session Tabs (Scrollable) -->
        <div id="sessionTabs" class="scroll-container mb-3">
            <!-- JS Generated -->
        </div>

        <!-- Search Bar -->
        <div class="row mb-3 gx-2 align-items-center">
            <div class="col">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="search" id="searchInput" class="form-control border-start-0"
                        placeholder="搜尋姓名、班級或組別 (按 Enter 新增篩選)" onkeyup="handleSearchInput(event)"
                        oninput="renderAll()">
                </div>
                <div id="searchTagsContainer" class="d-flex flex-wrap gap-2 mt-2"></div>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-12">
                <div class="stat-card border-start border-5 border-primary">
                    <div class="row mb-3 align-items-center">
                        <div class="col-12 d-flex justify-content-between align-items-start">
                            <h5 class="mb-0 d-flex align-items-center py-1">
                                總覽 <small class="text-muted mx-2" id="currentSessionLabel"></small>
                            </h5>
                            <div class="d-flex flex-column gap-2 ms-2">
                                <button class="btn btn-outline-primary btn-sm text-nowrap" onclick="copyGlobalReport()">
                                    <i class="bi bi-clipboard"></i> 複製總覽
                                </button>
                                <button class="btn btn-outline-primary btn-sm text-nowrap"
                                    onclick="openQuickStatusModal()">
                                    <i class="bi bi-lightning-fill"></i> 快速差勤
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-4 align-items-center" id="globalStatsPanel">
                        <span class="spinner-border spinner-border-sm" role="status"></span> 載入統計中...
                    </div>
                </div>
            </div>
        </div>



        <div id="classContainer" class="row g-4">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">連線中...</p>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增人員</h5>
                    <button type="button" class="btn-primary btn-sm ms-auto me-2 btn" data-bs-toggle="modal"
                        data-bs-target="#batchAddModal">批量新增</button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="form-floating"><input type="text" id="inputClass" class="form-control"
                                    placeholder="班級"><label for="inputClass">班級 (例: 101)</label></div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating"><input type="text" id="inputGroup" class="form-control"
                                    placeholder="組別"><label for="inputGroup">組別 (例: A組)</label></div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating"><input type="text" id="inputName" class="form-control"
                                    placeholder="姓名"><label for="inputName">姓名</label></div>
                        </div>
                        <div class="col-12 text-end">
                            <button onclick="addStudent()" class="btn btn-primary btn-lg w-100 shadow-sm"><i
                                    class="bi bi-plus-lg"></i> 確定新增</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">差勤狀態設定</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="addStatusContainer" class="input-group mb-3"><input type="text" id="newStatusInput"
                            class="form-control" placeholder="輸入新狀態名稱"><button class="btn btn-primary"
                            onclick="addNewStatusType()">新增</button></div>
                    <hr>
                    <h6>目前可用狀態:</h6>
                    <div id="statusListContainer" class="d-flex flex-wrap"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="batchAddModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量新增學生</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small">格式：<strong>班級 組別 姓名</strong> (中間空白)<br>範例：<br>101 A組 王小明
                    </div>
                    <textarea id="batchInput" class="form-control" rows="10" placeholder="101 A組 王小明"></textarea>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">取消</button><button type="button" class="btn btn-primary"
                        onclick="batchAddStudents()">開始匯入</button></div>
            </div>
        </div>
    </div>

    <!-- Login Modal (For Students) -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="loginModalTitle">登入</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="loginTargetName" class="fw-bold text-center fs-5 mb-3"></p>
                    <input type="password" id="loginPassword" class="form-control text-center mb-3"
                        placeholder="請輸入密碼 (預設0000)">
                    <p id="loginError" class="text-danger small text-center mb-0"></p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary w-100" onclick="performLogin()">登入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="modal fade" id="adminLoginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="bi bi-shield-lock-fill me-2"></i>管理員登入</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" id="adminUsername" class="form-control" placeholder="帳號">
                    </div>
                    <div class="mb-3">
                        <input type="password" id="adminPassword" class="form-control" placeholder="密碼">
                    </div>
                    <p id="adminLoginError" class="text-danger small text-center mb-0"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-dark w-100" onclick="performAdminLogin()">登入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改密碼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">舊密碼</label>
                        <input type="password" id="oldPass" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">新密碼</label>
                        <input type="password" id="newPass" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">確認新密碼</label>
                        <input type="password" id="confirmPass" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitChangePassword()">確認修改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Modal -->
    <div class="modal fade" id="adminDashboardModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="bi bi-shield-lock-fill me-2"></i>人員權限管理</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <select id="adminClassFilter" class="form-select" style="max-width: 200px;"
                            onchange="renderAdminUserList()">
                            <option value="all">所有班級/組別</option>
                        </select>
                        <script>
                            (function () {
                                const sel = document.getElementById('adminClassFilter');
                                if (sel) {
                                    const opts = [
                                        ...classOrder.map(c => `<option value="${c}">${c}</option>`),
                                        ...groupOrder.map(g => `<option value="${g}">${g}</option>`)
                                    ];
                                    sel.innerHTML += opts.join('');
                                }
                            })();
                        </script>
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="adminUserSearch" class="form-control" placeholder="搜尋姓名、班級、組別或權限..."
                            oninput="renderAdminUserList()">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>姓名</th>
                                    <th>班級 / 組別</th>
                                    <th>權限角色</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="adminUserListBody">
                                <!-- JS Generated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-bold" id="exportModalTitle"><i class="bi bi-share-fill me-2"></i>匯出點名單
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="exportForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">選擇日期：</label>
                            <select class="form-select" id="exportDaySelect">
                                <!-- Options populated via JS -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">選擇時段 (可多選)：</label>
                            <div class="d-flex flex-wrap gap-2" id="exportSessionChecks">
                                <!-- Checkboxes populated via JS -->
                            </div>
                        </div>
                        <input type="hidden" id="exportTargetType" value="">
                        <input type="hidden" id="exportTargetValue" value="">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="executeExport()">
                        <i class="bi bi-clipboard me-1"></i> 確認複製
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div class="modal fade" id="approvalModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold"><i class="bi bi-clipboard-check me-2"></i>審核申請</h5>
                    <select id="approvalClassFilter" class="form-select form-select-sm ms-3" style="max-width: 150px;"
                        onchange="refreshApprovalModal()">
                        <option value="all">顯示全部</option>
                        <!-- Options populated via JS -->
                    </select>
                    <div class="ms-auto me-2">
                        <button class="btn btn-success btn-sm me-1"
                            onclick="batchHandleRequests('approve')">全部批准</button>
                        <button class="btn btn-danger btn-sm" onclick="batchHandleRequests('reject')">全部駁回</button>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="approvalList" class="list-group list-group-flush">
                        <!-- JS Generated Requests -->
                        <div class="text-center p-4 text-muted">目前沒有待審核的申請</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, setDoc, getDocs, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyACL_67nXJU6RZEf3InFqHQJ-5h6FMZ7t8",
            authDomain: "check-74ee8.firebaseapp.com",
            projectId: "check-74ee8",
            storageBucket: "check-74ee8.firebasestorage.app",
            messagingSenderId: "795590503656",
            appId: "1:795590503656:web:f68019efd5eb88aa51ed5d",
            measurementId: "G-QMBN11NQ34"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const studentsRef = collection(db, "students");
        const requestsRef = collection(db, "requests"); // New collection for approval requests
        const configRef = doc(db, "settings", "globalConfig");

        const sessions = ["早點名", "早上上餐廳", "0740集合", "中午上餐廳", "1320集合", "晚上上餐廳", "晚自習", "晚點名", "備用點名"];
        const days = ["星期一", "星期二", "星期三", "星期四", "星期五", "星期六", "星期日"];

        let currentSession = sessions[0];
        let currentDay = days[0];
        let currentGroupMode = "class";
        let currentStatuses = ["實到", "遲到", "缺席"];

        // Define Orders Globally for reuse
        const classOrder = [
            "01班", "02班", "03班", "04班", "05班", "06班",
            "07班", "08班", "09班", "10班", "11班", "12班",
            "中隊部", "參謀", "區隊部"
        ];
        const groupOrder = [
            "115一般組", "115結構組", "115發修組", "115航設組",
            "116一般組", "116結構組", "116發修組", "116航設組",
            "專軍"
        ];

        let studentsData = [];
        let pendingRequests = []; // Store active requests

        let currentUser = null; // { id, name, role, class, group }
        // Check session storage
        try {
            const storedUser = sessionStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
            }
        } catch (e) {
            console.error("Session load error", e);
        }

        // 初始化
        initWeekTabs();
        initSessionTabs();

        // 功能: 複製
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => alert("已複製到剪貼簿！"))
                    .catch(err => fallbackCopyTextToClipboard(text));
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                var successful = document.execCommand('copy');
                var msg = successful ? '已複製到剪貼簿！' : '複製失敗';
                alert(msg);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                alert("複製失敗 (瀏覽器不支援)");
            }
            document.body.removeChild(textArea);
        }

        // Helper to strip HTML from status (Robust & Recursive Version)
        function stripStatusHtml(status) {
            if (!status) return "";
            let s = status;

            // 1. Recursive Unescape (Handle double encoding &amp;lt;)
            let maxLoop = 5;
            while (s.includes('&') && maxLoop > 0) {
                const temp = document.createElement('div');
                temp.innerHTML = s;
                s = temp.textContent || temp.innerText || "";
                maxLoop--;
            }

            // 2. Regex to remove standard and malformed HTML tags
            // Matches < or </, followed by optional whitespace, followed by tag name
            return s.replace(/<\/?\s*[a-z][^>]*>/gi, '').trim();
        }

        // Export Modal Logic
        window.openExportModal = (type, value, title) => {
            const modalTitle = document.getElementById('exportModalTitle');
            const daySelect = document.getElementById('exportDaySelect');
            const sessionChecks = document.getElementById('exportSessionChecks');

            modalTitle.innerHTML = `<i class="bi bi-share-fill me-2"></i>匯出點名單 - ${title}`;
            document.getElementById('exportTargetType').value = type; // 'global' or 'group'
            document.getElementById('exportTargetValue').value = value || '';

            // Populate Days
            const daysOfWeek = ['星期一', '星期二', '星期三', '星期四', '星期五', '星期六', '星期日'];
            daySelect.innerHTML = daysOfWeek.map(d =>
                `<option value="${d}" ${d === currentDay ? 'selected' : ''}>${d}</option>`
            ).join('');

            // Populate Sessions
            sessionChecks.innerHTML = sessions.map((s, idx) => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${s}" id="exportSession${idx}" ${s === currentSession ? 'checked' : ''}>
                    <label class="form-check-label" for="exportSession${idx}">${s}</label>
                </div>
            `).join('');

            bootstrap.Modal.getOrCreateInstance(document.getElementById('exportModal')).show();
        };

        window.executeExport = () => {
            const type = document.getElementById('exportTargetType').value;
            const value = document.getElementById('exportTargetValue').value;
            const selectedDay = document.getElementById('exportDaySelect').value;

            // Get checked sessions
            const selectedSessions = Array.from(document.querySelectorAll('#exportSessionChecks input:checked')).map(cb => cb.value);

            if (selectedSessions.length === 0) return alert("請至少選擇一個時段");

            let combinedText = "";
            selectedSessions.forEach((sess, index) => {
                if (index > 0) combinedText += "\n\n";
                // Pass specific day and session to generate logic
                const report = generateCustomReportText(type, value, selectedDay, sess);
                combinedText += report;
            });

            copyToClipboard(combinedText);
            bootstrap.Modal.getOrCreateInstance(document.getElementById('exportModal')).hide();
        };

        // Custom Report Generation (Modified from original generateReportText)
        function generateCustomReportText(scope, groupName, day, session) {
            let output = "";
            const statusKeyPrefix = `${day}_${session}`;
            // Use existing logic but strictly for the specified day/session

            output += `${session}\n`; // Just session name as requested

            // Filter data logic...
            // Need to reconstruct stats based on input day/session, not current globals

            // Re-fetch all data isn't needed, we have studentsData.

            let targetStudents = studentsData;
            if (scope === 'group' && groupName) {
                targetStudents = studentsData.filter(s => (currentGroupMode === 'class' ? s.class : s.group) === groupName);
                // output += `${groupName} 點名單\n`; // Removed as per user request
            } else {
                // Global Scope: Apply Search Tags Filter if any to match UI
                if (typeof searchTags !== 'undefined' && searchTags.length > 0) {
                    targetStudents = studentsData.filter(student => {
                        const sName = student.name.toLowerCase();
                        const sClass = student.class.toLowerCase();
                        const sGroup = (student.group || '').toLowerCase();
                        return searchTags.some(tag => {
                            const t = tag.toLowerCase();
                            return sName.includes(t) || sClass.includes(t) || sGroup.includes(t);
                        });
                    });
                }
                // output += `總覽報表\n`; // Removed
            }

            let total = 0;
            const stats = { '實到': 0 };
            const detailList = {};
            currentStatuses.forEach(s => { if (s !== '實到') detailList[s] = []; });

            targetStudents.forEach(s => {
                total++;
                // Access status from DB: key is e.g. "星期一_早點名"
                const key = `${day}_${session}`;
                let rawStatus = (s.status && s.status[key]) ? s.status[key] : '實到';
                // Fix: Strip HTML if present
                const status = stripStatusHtml(rawStatus);

                if (status === '實到') stats['實到']++;
                else {
                    if (!detailList[status]) detailList[status] = []; // Init if new status type
                    detailList[status].push(s.name);
                }
            });

            output += `應到${total}\n`; // No colon as per request
            output += `事故：\n`;
            Object.entries(detailList).forEach(([status, names]) => {
                if (names.length > 0) {
                    output += `${status}${names.length} ${names.join(' ')}\n`;
                }
            });
            output += `實到：${stats['實到']}\n`;

            return output;
        }

        function getStatusKey(session) {
            return `${currentDay}_${session}`;
        }


        // Multi-select Search Tags
        let searchTags = [];

        onSnapshot(configRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                if (data.statuses && Array.isArray(data.statuses)) {
                    // Sanitize statuses on load to clean up specific DB corruption
                    currentStatuses = data.statuses.map(s => stripStatusHtml(s)).filter(s => s.trim() !== "");
                    renderStatusSettings();
                    renderAll();
                }
            } else {
                // Document doesn't exist -> Use defaults locally but DO NOT overwrite DB automatically
                // This prevents accidental resets if connection is flaky or doc is temporarily unavailable
                console.warn("Config document not found. Using default statuses.");
                currentStatuses = ["實到", "遲到", "缺席", "病假", "事假", "公假"];
                renderStatusSettings();
                renderAll();
            }
        });

        const q = query(studentsRef);
        const unsubscribeStudents = onSnapshot(q, (snapshot) => {
            studentsData = [];
            snapshot.forEach((doc) => studentsData.push({ id: doc.id, ...doc.data() }));
            studentsData.sort((a, b) => {
                if (a.class !== b.class) return a.class.localeCompare(b.class);
                return (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0);
            });
            try { renderAll(); } catch (err) { console.error(err); }
        });

        const requestsQ = query(requestsRef);
        const unsubscribeRequests = onSnapshot(requestsQ, (snapshot) => {
            pendingRequests = [];
            snapshot.forEach((doc) => {
                pendingRequests.push({ id: doc.id, ...doc.data() });
            });
            renderAll(); // Re-render when requests change
            if (typeof updateNotificationBadge === 'function') updateNotificationBadge(); // Helper: Force badge update
            if (typeof refreshApprovalModal === 'function') refreshApprovalModal(); // Refresh modal content if open
        });

        function initWeekTabs() {
            const container = document.getElementById('weekTabs');
            container.innerHTML = days.map(d => `
                <button class="btn ${currentDay === d ? 'btn-primary' : 'btn-outline-secondary'} rounded-pill text-nowrap px-4" 
                        onclick="changeDay('${d}')">${d}</button>
            `).join('');
        }

        function initSessionTabs() {
            const container = document.getElementById('sessionTabs');
            container.innerHTML = sessions.map(s => `
                <button class="btn ${currentSession === s ? 'btn-primary' : 'btn-white bg-white border'} rounded-pill text-nowrap px-3 shadow-sm" 
                        onclick="changeSession('${s}')">${currentDay} - ${s}</button>
            `).join('');
        }

        window.changeDay = (d) => {
            currentDay = d;
            initWeekTabs();
            initSessionTabs();
            renderAll();
        };

        window.changeSession = (s) => {
            currentSession = s;
            initSessionTabs();
            renderAll();
        };

        function renderAll(searchTerm = '') {
            if (currentUser && typeof updateNotificationBadge === 'function') {
                try { updateNotificationBadge(); } catch (e) { }
            }

            const container = document.getElementById('classContainer');
            const globalStatsPanel = document.getElementById('globalStatsPanel');
            document.getElementById('currentSessionLabel').innerText = `(${currentDay} - ${currentSession})`;
            container.innerHTML = ""; globalStatsPanel.innerHTML = "";

            // Filter Data
            let inputTerm = searchTerm ? searchTerm.toLowerCase().trim() : '';
            // Get value from input directly if not passed (though oninput passes it)
            if (!inputTerm) {
                const inputEl = document.getElementById('searchInput');
                if (inputEl) inputTerm = inputEl.value.toLowerCase().trim();
            }

            const displayedStudents = studentsData.filter(student => {
                const sName = student.name.toLowerCase();
                const sClass = student.class.toLowerCase();
                const sGroup = (student.group || '').toLowerCase();

                // 1. Check Input Term (Partial Match)
                const matchesInput = !inputTerm || (
                    sName.includes(inputTerm) ||
                    sClass.includes(inputTerm) ||
                    sGroup.includes(inputTerm)
                );

                // 2. Check Tags (OR Logic - Match ANY tag)
                // If no tags, ignore this check (true). If tags exist, must match at least one.
                let matchesTags = true;
                if (searchTags.length > 0) {
                    matchesTags = searchTags.some(tag => {
                        const t = tag.toLowerCase();
                        return sName.includes(t) || sClass.includes(t) || sGroup.includes(t);
                    });
                }

                // Final Decision: Must match Input (if any) AND Tags (if any)
                // Wait, User requested "Accumulate results". 
                // "Search 3rd Class -> Show. Then Search 4th Class -> Show Both."
                // This implies tags should be combined with OR logic.
                // Input term is "temporary tag".

                // Logic Adjustment:
                // If (Input matches OR match any Tag) -> Show.
                // If NO input AND NO tags -> Show All.

                if (!inputTerm && searchTags.length === 0) return true;

                let hit = false;
                if (inputTerm && (sName.includes(inputTerm) || sClass.includes(inputTerm) || sGroup.includes(inputTerm))) {
                    hit = true;
                }
                if (!hit && searchTags.length > 0) {
                    if (searchTags.some(tag => {
                        const t = tag.toLowerCase();
                        return sName.includes(t) || sClass.includes(t) || sGroup.includes(t);
                    })) {
                        hit = true;
                    }
                }
                return hit;
            });

            const grouped = {};
            const globalStats = { total: 0, byStatus: {}, byStatusNames: {} };
            currentStatuses.forEach(s => {
                globalStats.byStatus[s] = 0;
                globalStats.byStatusNames[s] = [];
            });

            displayedStudents.forEach(student => {
                let key = currentGroupMode === 'class' ? student.class : student.group;
                if (!key) key = "未分組";
                if (!grouped[key]) {
                    // Initialize group stats with names array
                    grouped[key] = { students: [], stats: { total: 0, byStatus: {}, byStatusNames: {} } };
                    currentStatuses.forEach(s => {
                        grouped[key].stats.byStatus[s] = 0;
                        grouped[key].stats.byStatusNames[s] = [];
                    });
                }
                grouped[key].students.push(student);

                // Use Composite Key
                const statusKey = getStatusKey(currentSession);
                let status = "實到";
                if (student.status && student.status[statusKey]) status = student.status[statusKey];
                // Sanitize status immediately
                status = stripStatusHtml(status);
                student._currentStatus = status;

                globalStats.total++;

                // Dynamically init status if unknown
                if (globalStats.byStatus[status] === undefined) {
                    globalStats.byStatus[status] = 0;
                    globalStats.byStatusNames[status] = [];
                }

                globalStats.byStatus[status]++;
                // Only push name if not '實到'
                if (status !== '實到') {
                    globalStats.byStatusNames[status].push(student.name);
                }

                // Same for group stats
                grouped[key].stats.total++;
                if (grouped[key].stats.byStatus[status] === undefined) {
                    grouped[key].stats.byStatus[status] = 0;
                    grouped[key].stats.byStatusNames[status] = [];
                }
                grouped[key].stats.byStatus[status]++;
                if (status !== '實到') {
                    grouped[key].stats.byStatusNames[status].push(student.name);
                }
            });

            // Global Stats
            let globalStatsHtml = `
                <div class="d-flex align-items-center me-4 mb-2">
                    <span class="text-muted small me-2">應到</span>
                    <span class="fs-4 fw-bold text-dark">${globalStats.total}</span>
                </div>
                <div class="d-flex align-items-center me-4 mb-2">
                    <span class="text-muted small me-2">實到</span>
                    <span class="fs-4 fw-bold text-success">${globalStats.byStatus['實到'] || 0}</span>
                </div>
            `;

            let breakdownHtml = "";
            Object.entries(globalStats.byStatusNames).forEach(([status, names]) => {
                if (status !== '實到' && names.length > 0) {
                    breakdownHtml += `
                        <div class="mb-1">
                            <span class="badge bg-light text-danger border border-danger me-1">${status} (${names.length})</span>
                            <span class="small text-secondary">${names.join(', ')}</span>
                        </div>
                    `;
                }
            });

            if (breakdownHtml) {
                globalStatsHtml += `<div class="d-flex flex-column border-start ps-3 ms-2">${breakdownHtml}</div>`;
            } else {
                globalStatsHtml += `<div class="d-flex flex-column border-start ps-3 ms-2"><span class="text-muted small">全員實到</span></div>`;
            }

            globalStatsPanel.innerHTML = globalStatsHtml;

            if (Object.keys(grouped).length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted py-5">目前沒有資料，請從上方新增。</div>`;
                return;
            }

            // Custom Sort Orders used from global scope

            const sortedKeys = Object.keys(grouped).sort((a, b) => {
                const order = currentGroupMode === 'class' ? classOrder : groupOrder;
                const indexA = order.indexOf(a);
                const indexB = order.indexOf(b);

                // Known items first
                if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;

                // Unknown items alphabetically
                return a.localeCompare(b, 'zh-Hant');
            });

            sortedKeys.forEach(key => {
                const groupName = key;
                const group = grouped[key];

                let classStatStr = `應到: ${group.stats.total} | 實到: ${group.stats.byStatus['實到'] || 0}`;

                // Generate class detail string
                let classDetailHtml = "";
                Object.entries(group.stats.byStatusNames).forEach(([status, names]) => {
                    if (status !== '實到' && names.length > 0) {
                        classDetailHtml += `<div class="text-end" style="font-size: 0.85rem;">${status}: ${names.length} (${names.join(' ')})</div>`;
                    }
                });

                const rows = group.students.map(student => {
                    // Determine Permissions
                    let canEdit = false;
                    let canDelete = false;

                    if (currentUser) {
                        if (currentUser.role === 'super_admin') {
                            canEdit = true;
                            canDelete = true;
                        } else if (currentUser.role === 'general_admin') {
                            canEdit = true;
                            canDelete = true;
                        } else if (currentUser.role === 'class_admin') {
                            if (currentUser.class === student.class) {
                                canEdit = true;
                                canDelete = false; // Restricted
                            }
                        } else if (currentUser.role === 'district_admin') {
                            if (currentUser.managedClasses && currentUser.managedClasses.includes(student.class)) {
                                canEdit = true;
                            }
                        } else if (currentUser.role === 'group_admin') {
                            // Dining sessions: edit group members. Other times: only self
                            const isDining = (currentSession === '中午上餐廳' || currentSession === '晚上上餐廳');
                            if (isDining && student.group === currentUser.group) {
                                canEdit = true;
                            } else if (currentUser.id === student.id) {
                                canEdit = true;
                            }
                        } else { // student
                            if (currentUser.id === student.id) canEdit = true;
                        }
                    }

                    // Check for Pending Requests
                    const sessionKey = `${currentDay}_${currentSession}`;

                    const pendingReq = pendingRequests.find(r =>
                        r.studentId === student.id &&
                        r.targetSession === sessionKey &&
                        r.status === 'pending'
                    );

                    let statusDisplay = getStatusBadge(student._currentStatus);
                    let rowStyle = "";

                    if (pendingReq) {
                        statusDisplay = `<span class="badge bg-warning text-dark">審核中: ${pendingReq.newStatus}</span>`;
                        canEdit = false; // Lock editing while pending
                        rowStyle = "background-color: #fff3cd;"; // Light yellow row
                    }

                    // Onclick name: if not logged in, trigger login. If logged in but no edit, do nothing or show info.
                    const nameAction = !currentUser ? `onclick="initLogin('${student.id}', '${student.name}')" style="cursor: pointer; text-decoration: underline;"` : '';

                    return `
                    <tr style="${rowStyle}">
                        <td>
                            <span class="fw-bold ${getNameColorClass(student._currentStatus)}" ${nameAction}>${student.name}</span>
                            <br><span class="badge bg-light text-secondary border">${student.class} / ${student.group || '-'}</span>
                        </td>
                        <td>${statusDisplay}</td>
                        <td>
                            <select class="form-select form-select-sm fw-bold ${getStatusColorClass(student._currentStatus)}" 
                                    onchange="updateStatus('${student.id}', this.value)" 
                                    style="min-width: 110px;"
                                    ${canEdit ? '' : 'disabled'}>
                                ${currentStatuses.map(s => {
                        const sClean = stripStatusHtml(s);
                        return `<option value="${s}" ${student._currentStatus === sClean ? 'selected' : ''}>${sClean}</option>`;
                    }).join('')}
                            </select>
                        </td>
                         <td class="text-end">
                            ${(pendingReq && currentUser && (currentUser.id === pendingReq.requesterId || currentUser.role === 'super_admin')) ?
                            `<button class="btn btn-sm btn-outline-danger" onclick="cancelRequest('${pendingReq.id}')" title="取消申請"><i class="bi bi-x-lg"></i></button>` :
                            (canDelete ? `<button class="btn btn-sm btn-light text-danger" onclick="removeStudent('${student.id}')"><i class="bi bi-trash"></i></button>` : '')
                        }
                        </td>
                    </tr>
                `}).join('');

                const card = `
                    <div class="col-xl-6 col-12">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="class-header d-flex justify-content-between align-items-start">
                                <div class="d-flex align-items-center mt-1">
                                    <span class="fs-5 me-2"><i class="bi bi-house-door-fill me-2"></i>${groupName}</span>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-link text-white p-0" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                        <ul class="dropdown-menu">
                                            <li><button class="dropdown-item" onclick="openExportModal('group', '${groupName}', '${groupName}')"><i class="bi bi-clipboard me-2"></i>匯出/複製本班點名單</button></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><button class="dropdown-item text-danger" onclick="resetStatus('current', '${groupName}')"><i class="bi bi-arrow-counterclockwise me-2"></i>重置 (本次)</button></li>
                                            <li><button class="dropdown-item text-danger" onclick="resetStatus('day', '${groupName}')"><i class="bi bi-calendar-x me-2"></i>重置 (整天)</button></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="d-flex flex-column align-items-end">
                                    <span class="badge bg-light text-dark opacity-75 fw-normal fs-6 mb-1">${classStatStr}</span>
                                    <div class="text-white opacity-90">${classDetailHtml}</div>
                                </div>
                            </div>
                            <div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th style="width: 25%">姓名</th><th style="width: 15%">狀態</th><th>操作</th><th style="width: 10%"></th></tr></thead><tbody>${rows}</tbody></table></div></div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });

            // Re-apply search filter if exists - REMOVED because filterStudents() conflicts with renderAll's internal filtering logic
            // if (document.getElementById('searchInput').value.trim()) {
            //     filterStudents();
            // }
        }

        window.migrateData = async () => {
            if (!confirm('確定要執行資料遷移？這將為所有學生設定預設密碼 0000 與角色 student。')) return;
            console.log("開始遷移資料...");
            const snapshot = await getDocs(studentsRef);
            let updateCount = 0;
            const promises = [];

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                // Check if migration is needed
                if (!data.password || !data.role) {
                    promises.push(updateDoc(doc(db, "students", docSnap.id), {
                        password: data.password || '0000',
                        role: data.role || 'student'
                    }));
                    updateCount++;
                }
            });

            try {
                await Promise.all(promises);
                console.log(`遷移完成！共更新 ${updateCount} 筆資料。`);
                alert(`遷移完成！共更新 ${updateCount} 筆資料。`);
            } catch (e) {
                console.error("遷移失敗", e);
                alert("遷移失敗，請查看 Console。");
            }
        };
        window.changeSession = (n) => { currentSession = n; initSessionTabs(); renderAll(); };
        window.setGroupBy = (m) => { currentGroupMode = m; renderAll(); };
        window.addStudent = async () => {
            if (!currentUser || (currentUser.role !== 'super_admin' && currentUser.role !== 'general_admin')) return alert("權限不足");
            const classInput = document.getElementById('inputClass').value.trim();
            const groupInput = document.getElementById('inputGroup').value.trim();
            const nameInput = document.getElementById('inputName').value.trim();
            if (!classInput || !nameInput) return alert("請輸入班級和姓名");
            try {
                await addDoc(studentsRef, {
                    class: classInput,
                    group: groupInput || "無",
                    name: nameInput,
                    status: {},
                    password: '0000',
                    role: 'student',
                    timestamp: new Date()
                });
                document.getElementById('inputName').value = '';
            } catch (e) { console.error(e); alert("新增失敗"); }
        };
        window.batchAddStudents = async () => {
            if (!currentUser || (currentUser.role !== 'super_admin' && currentUser.role !== 'general_admin')) return alert("權限不足");
            const input = document.getElementById('batchInput').value.trim();
            if (!input) return;
            const lines = input.split('\n');
            const promises = [];
            for (let line of lines) {
                line = line.trim();
                const parts = line.split(/\s+/);
                if (parts.length < 3) continue;
                promises.push(addDoc(studentsRef, {
                    class: parts[0],
                    group: parts[1],
                    name: parts.slice(2).join(' '),
                    status: {},
                    password: '0000',
                    role: 'student',
                    timestamp: new Date()
                }));
            }
            try {
                await Promise.all(promises);
                alert("匯入成功！");
                bootstrap.Modal.getOrCreateInstance(document.getElementById('batchAddModal')).hide();
                document.getElementById('batchInput').value = '';
            } catch (e) { console.error(e); alert("匯入失敗"); }
        };
        window.updateStatus = async (id, val) => {
            if (!currentUser) return;

            const student = studentsData.find(s => s.id === id);
            if (!student) return;

            let canDirectlyUpdate = false;

            if (currentUser.role === 'super_admin') {
                canDirectlyUpdate = true;
            } else if (currentUser.role === 'general_admin') {
                canDirectlyUpdate = true;
            } else if (currentUser.role === 'class_admin') {
                if (currentUser.class === student.class) canDirectlyUpdate = true;
            } else if (currentUser.role === 'district_admin') {
                if (currentUser.managedClasses && currentUser.managedClasses.includes(student.class)) {
                    canDirectlyUpdate = true;
                }
            } else if (currentUser.role === 'group_admin') {
                // Dining sessions: edit group members. Other times: only self (but self needs request?)
                // Plan: "Other times only can request for themselves". So Group Admin for others in non-dining = No.
                // Group Admin for self in non-dining = Request (based on "Students submit requests").

                const isDining = (currentSession === '中午上餐廳' || currentSession === '晚上上餐廳');
                if (isDining && student.group === currentUser.group) {
                    canDirectlyUpdate = true;
                }
                // Note: Self-update for students/admins outside their scope defaults to Request.
            }

            const statusKey = getStatusKey(currentSession);

            if (canDirectlyUpdate) {
                try {
                    const studentRef = doc(db, "students", id);
                    await updateDoc(studentRef, { [`status.${statusKey}`]: val });
                } catch (e) {
                    console.error("Error updating status: ", e);
                    alert("更新失敗: " + e.message);
                }
            } else {
                // Create Request
                try {
                    await addDoc(requestsRef, {
                        studentId: id,
                        studentName: student.name,
                        studentClass: student.class,
                        studentGroup: student.group || '',
                        targetSession: statusKey, // e.g. 星期一_早點名
                        sessionName: currentSession,
                        dayName: currentDay,
                        originStatus: (student.status && student.status[statusKey]) ? student.status[statusKey] : '實到',
                        newStatus: val,
                        requesterId: currentUser.id,
                        requesterName: currentUser.name,
                        timestamp: new Date().toISOString(),
                        status: 'pending' // pending, approved, rejected
                    });
                    alert("已送出狀態變更申請，請等待幹部審核。");
                    // Reset select to original value visually (will be handled by re-render, but good specifically)
                    renderAll();
                } catch (e) {
                    console.error("Error sending request: ", e);
                    alert("送出申請失敗: " + e.message);
                }
            }
        };
        window.removeStudent = async (id) => {
            if (!currentUser || (currentUser.role !== 'super_admin' && currentUser.role !== 'general_admin')) return alert("權限不足");
            if (confirm('確定刪除？')) await deleteDoc(doc(db, "students", id));
        };
        window.addNewStatusType = async () => {
            if (!currentUser || !['super_admin', 'general_admin', 'class_admin', 'group_admin'].includes(currentUser.role)) return alert("權限不足");
            const val = document.getElementById('newStatusInput').value.trim();
            if (!val || currentStatuses.includes(val)) return;
            await updateDoc(configRef, { statuses: [...currentStatuses, val] });
            document.getElementById('newStatusInput').value = '';
        };
        window.removeStatusType = async (val) => {
            if (!currentUser || !['super_admin', 'general_admin', 'class_admin', 'group_admin'].includes(currentUser.role)) return alert("權限不足");
            if (confirm(`移除 ${val}?`)) await updateDoc(configRef, { statuses: currentStatuses.filter(s => s !== val) });
        };

        window.resetStatus = async (scope, groupName) => {
            if (!currentUser) return alert("請先登入");

            // Permission Check
            let canReset = false;
            if (currentUser.role === 'super_admin' || currentUser.role === 'general_admin') canReset = true;
            if (currentUser.role === 'class_admin' && currentUser.class === groupName) {
                const isDining = (currentSession === '中午上餐廳' || currentSession === '晚上上餐廳');
                if (scope === 'day') {
                    // Class Admin cannot reset 'day' because it includes dining sessions which they don't manage
                    canReset = false;
                } else {
                    // Scope is current. Allow only if NOT dining.
                    canReset = !isDining;
                }
            }
            if (currentUser.role === 'group_admin' && currentUser.group === groupName) {
                // Group admin logic: usually restricted to dining, but for "Reset" let's allow if it's their group?
                // User asked for "Reset" on the 3 dots.
                // Let's stick to the rule: Group Admin only valid for Dining Sessions?
                // Or maybe just let them manage their group if they see the button.
                // However, "Reset All Day" might be too powerful if they only manage dining.
                // Let's restrict based on session for safety?
                // The prompt didn't specify, but safer to follow general rules.
                // Actually, "Reset All Day" implies modifying non-dining sessions.
                // If Group Admin is restricted to Dining, they shouldn't reset "Morning Call".
                // So "Reset All Day" should be BLOCKED for Group Admin if they are dining only.
                // Let's allow simple logic for now: If they can edit the group, they can reset.
                // But wait, group_admin logic in updateStatus was strict.
                // Let's check updateStatus logic:
                // Group Admin can edit IF isDining AND student.group == currentUser.group.
                // So if scope is 'day', it touches non-dining. Thus Group Admin cannot 'day'.
                if (scope === 'day') canReset = false;
                else {
                    // scope is 'current'. Is it dining?
                    const isDining = (currentSession === '中午上餐廳' || currentSession === '晚上上餐廳');
                    if (isDining) canReset = true;
                }
            }

            if (!canReset) return alert("權限不足");

            const label = scope === 'current' ? `本時段 (${currentSession})` : `今天 (${currentDay})`;
            if (!confirm(`確定要將 ${groupName} 的 ${label} 所有差勤狀態重置為「實到」嗎？此操作無法復原。`)) return;

            // Find target students
            const targets = studentsData.filter(s => {
                if (currentGroupMode === 'class') return s.class === groupName;
                if (currentGroupMode === 'group') return s.group === groupName;
                return false;
            });

            if (targets.length === 0) return alert("找不到學生資料");

            let updateCount = 0;
            const promises = [];

            for (const s of targets) {
                const updates = {};
                // Find and delete relevant pending requests
                const relevantRequests = pendingRequests.filter(r => r.studentId === s.id);

                if (scope === 'current') {
                    const key = `${currentDay}_${currentSession}`;
                    // Update Status
                    if (s.status && s.status[key] && s.status[key] !== '實到') {
                        updates[`status.${key}`] = deleteField();
                    }
                    // Also delete pending request for THIS session
                    const reqToDelete = relevantRequests.find(r => r.targetSession === key);
                    if (reqToDelete) {
                        promises.push(deleteDoc(doc(db, "requests", reqToDelete.id)));
                    }
                } else {
                    // 'day' scope: reset all sessions for currentDay
                    sessions.forEach(sess => {
                        const key = `${currentDay}_${sess}`;
                        if (s.status && s.status[key] && s.status[key] !== '實到') {
                            updates[`status.${key}`] = deleteField();
                        }
                        // Delete requests
                        const reqToDelete = relevantRequests.find(r => r.targetSession === key);
                        if (reqToDelete) {
                            promises.push(deleteDoc(doc(db, "requests", reqToDelete.id)));
                        }
                    });
                }

                if (Object.keys(updates).length > 0) {
                    promises.push(updateDoc(doc(db, "students", s.id), updates));
                    updateCount++;
                }
            }
            try {
                await Promise.all(promises);
                alert(`已重置 ${updateCount} 位學生的狀態。`);
                renderAll(); // Should trigger automatically by snapshot but good to force
            } catch (e) {
                console.error(e);
                alert("重置失敗: " + e.message);
            }
        };
        // --- Multi-select Search Logic ---

        window.handleSearchInput = (event) => {
            if (event.key === 'Enter') {
                const term = event.target.value.trim();
                window.addSearchTag(term);
            }
        };

        window.addSearchTag = (term) => {
            if (term && !searchTags.includes(term)) {
                searchTags.push(term);
                document.getElementById('searchInput').value = ''; // Clear input
                renderSearchTags();
                renderAll();
            } else if (term) {
                document.getElementById('searchInput').value = ''; // Clear duplicate
            }
        };

        window.removeSearchTag = (index) => {
            searchTags.splice(index, 1);
            renderSearchTags();
            renderAll();
        };

        // Render Search Tags
        window.renderSearchTags = () => {
            const container = document.getElementById('searchTagsContainer');
            if (!container) return;
            container.innerHTML = searchTags.map((tag, index) => `
                <span class="badge bg-primary d-flex align-items-center gap-2 px-3 py-2 fs-6">
                    ${tag}
                    <i class="bi bi-x-circle-fill cursor-pointer" onclick="removeSearchTag(${index})"></i>
                </span>
            `).join('');
        };

        window.renderStatusSettings = () => {
            const container = document.getElementById('currentStatusList');
            container.innerHTML = currentStatuses.map(s => {
                const sClean = stripStatusHtml(s);
                return `
                <div class="custom-status-tag border rounded px-2 py-1 bg-light">
                    ${sClean}
                    <i class="bi bi-x ms-2 text-danger cursor-pointer" onclick="removeStatusType('${s}')"></i>
                </div>
                `;
            }).join('');
        };

        // Export helper functions
        window.copyToClipboard = copyToClipboard;
        // window.generateReportText = generateReportText; // Removed to fix RefError
        window.renderAll = renderAll;
        window.copyGlobalReport = () => openExportModal('global', null, '總覽');

        // --- Auth & Login Logic ---

        // Update UI based on login status
        function updateAuthUI() {
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            const userNameDisplay = document.getElementById('userNameDisplay');
            const notificationBtn = document.getElementById('notificationBtn');
            const adminManageLink = document.getElementById('adminManageLink');

            if (currentUser) {
                adminLoginBtn.classList.add('d-none');
                userInfoDisplay.classList.remove('d-none');
                userInfoDisplay.classList.add('d-flex');

                let roleName = "學生";
                let isAdmin = false;

                // Priority: Custom Title > Role Mapping
                if (currentUser.customRoleTitle) {
                    roleName = currentUser.customRoleTitle;
                    if (['super_admin', 'general_admin'].includes(currentUser.role)) isAdmin = true;
                } else if (currentUser.role === 'super_admin') { roleName = "超級管理員"; isAdmin = true; }
                else if (currentUser.role === 'general_admin') { roleName = "管理員"; isAdmin = true; }
                else if (currentUser.role === 'class_admin') { roleName = "實習幹部"; isAdmin = true; }
                else if (currentUser.role === 'group_admin') { roleName = "組別班代"; isAdmin = true; }

                userNameDisplay.innerHTML = `${currentUser.name} <span class="badge bg-secondary ms-1" style="font-size: 0.7em;">${roleName}</span>`;

                if (isAdmin) {
                    notificationBtn.classList.remove('d-none');
                    updateNotificationBadge();
                } else {
                    notificationBtn.classList.add('d-none');
                }

                if (currentUser.role === 'super_admin' || currentUser.role === 'general_admin') {
                    adminManageLink.classList.remove('d-none');
                } else {
                    adminManageLink.classList.add('d-none');
                }

                // Control Add Student Button visibility
                const addStudentBtn = document.getElementById('addStudentBtn');
                if (currentUser.role === 'super_admin' || currentUser.role === 'general_admin') {
                    addStudentBtn.classList.remove('d-none');
                } else {
                    addStudentBtn.classList.add('d-none');
                }

            } else {
                adminLoginBtn.classList.remove('d-none');
                userInfoDisplay.classList.add('d-none');
                userInfoDisplay.classList.remove('d-flex');
                notificationBtn.classList.add('d-none');
                adminManageLink.classList.add('d-none');

                // Hide Add btn if not logged in (or show if you want default to be visible? No, default should be hidden or visible? 
                // Original behavior: it was visible. 
                // Requirement: "Student Cadre cannot add". 
                // If not logged in, who are they? Guest. Should Guest add? Probably not.
                // Let's hide it for consistency.
                const addStudentBtn = document.getElementById('addStudentBtn');
                if (addStudentBtn) addStudentBtn.classList.add('d-none');
            }
            renderAll(); // Re-render to update permissions
            renderStatusSettings(); // Re-render settings modal UI based on new permissions
        }

        window.showAdminDashboard = () => {
            renderAdminUserList();
            bootstrap.Modal.getOrCreateInstance(document.getElementById('adminDashboardModal')).show();
        };

        window.showAddStudentModal = () => {
            bootstrap.Modal.getOrCreateInstance(document.getElementById('addStudentModal')).show();
        };

        window.renderAdminUserList = () => {
            const tbody = document.getElementById('adminUserListBody');
            const term = document.getElementById('adminUserSearch').value.toLowerCase();
            const filterClass = document.getElementById('adminClassFilter') ? document.getElementById('adminClassFilter').value : 'all';

            const filtered = studentsData.filter(s => {
                const matchesSearch = s.name.includes(term) ||
                    s.class.includes(term) ||
                    (s.group && s.group.includes(term)) ||
                    (s.role || 'student').includes(term);

                const matchesFilter = filterClass === 'all' || s.class === filterClass || s.group === filterClass;

                return matchesSearch && matchesFilter;
            });

            const roleOptions = [
                { val: 'student', label: '學生' },
                { val: 'group_admin', label: '組別班代' },
                { val: 'class_admin', label: '實習幹部' },
                { val: 'general_admin', label: '管理員' }
            ];

            tbody.innerHTML = filtered.map(s => {
                const currentRole = s.role || 'student';
                return `
                    <tr>
                        <td>${s.name}</td>
                        <td>
                             <div class="d-flex align-items-center">
                                <select class="form-select form-select-sm me-1" onchange="updateUserClass('${s.id}', this.value)" style="width: auto; min-width: 80px;">
                                    ${classOrder.map(c => `<option value="${c}" ${s.class === c ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                                <small class="text-muted text-nowrap">(${s.group || '-'})</small>
                            </div>
                        </td>
                        <td>
                            <select class="form-select form-select-sm" onchange="updateUserRole('${s.id}', this.value)">
                                ${roleOptions.map(opt => `<option value="${opt.val}" ${currentRole === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('')}
                            </select>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary" onclick="resetUserPassword('${s.id}', '${s.name}')">重置密碼</button>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        window.updateUserClass = async (uid, newClass) => {
            if (currentUser.role !== 'super_admin' && currentUser.role !== 'general_admin') {
                alert("您沒有權限執行此操作。");
                renderAdminUserList(); // Revert UI
                return;
            }
            try {
                await updateDoc(doc(db, "students", uid), { class: newClass });
                // Optimistic update
                const student = studentsData.find(s => s.id === uid);
                if (student) student.class = newClass;
                // Render list again isn't strictly necessary if optimistic update works, 
                // but good for consistency. However, onchange already changed the UI.
            } catch (e) {
                console.error(e);
                alert("更新班級失敗: " + e.message);
                renderAdminUserList(); // Revert on fail
            }
        };


        window.updateUserRole = async (uid, newRole) => {
            if (currentUser.role !== 'super_admin') {
                alert("您沒有權限執行此操作。");
                return;
            }
            try {
                await updateDoc(doc(db, "students", uid), { role: newRole });
                // alert("權限已更新");
                studentsData.find(s => s.id === uid).role = newRole; // Optimistic update
            } catch (e) {
                console.error(e);
                alert("更新失敗: " + e.message);
            }
        };

        window.resetUserPassword = async (uid, name) => {
            if (!confirm(`確定要將 ${name} 的密碼重置為 0000 嗎？`)) return;
            try {
                await updateDoc(doc(db, "students", uid), { password: '0000' });
                alert("密碼已重置為 0000");
            } catch (e) {
                console.error(e);
                alert("重置失敗: " + e.message);
            }
        };

        function getRelevantRequests() {
            if (!currentUser) return [];
            return pendingRequests.filter(req => {
                if (req.status !== 'pending') return false;

                if (currentUser.role === 'super_admin' || currentUser.role === 'general_admin') return true;
                if (currentUser.role === 'class_admin') {
                    return req.studentClass === currentUser.class;
                }
                if (currentUser.role === 'group_admin') {
                    // Only dining sessions for Group Admin? Or all? 
                    // Plan: "Group Admin approval rights restricted to dining sessions."
                    // Let's implement that strict check.
                    // Wait, req contains `targetSession` (key) and `sessionName`.
                    // Check if sessionName contains "餐廳" ?
                    const isDining = (req.sessionName === '中午上餐廳' || req.sessionName === '晚上上餐廳');
                    if (isDining && req.studentGroup === currentUser.group) return true;
                    // Else: Cannot approve. 
                }
                return false;
            });
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const relevant = getRelevantRequests();
            const count = relevant.length;

            if (count > 0) {
                badge.innerText = count;
                badge.classList.remove('d-none');
            } else {
                badge.classList.add('d-none');
            }
        }

        // Hook updateNotificationBadge into renderAll/snapshot
        // Actually better to hook where pendingRequests updates.
        // I'll add a call to updateNotificationBadge inside the requests snapshot listener in the next step or manually add it here if I can find the listener.
        // But wait, `renderAll` is called by the listener. So I can just add `updateNotificationBadge()` inside `renderAll`? 
        // Yes, let's add it to `renderAll` or `updateAuthUI`. 
        // Since `renderAll` is called frequently, let's put it there. 
        // However, `renderAll` doesn't have access to this scope easily if strictly separated? 
        // They are all in module scope. It's fine.

        window.showApprovalModal = () => {
            const list = document.getElementById('approvalList');
            const relevant = getRelevantRequests();

            // Populate Filter Options if empty
            const filterSel = document.getElementById('approvalClassFilter');
            if (filterSel && filterSel.options.length === 1) {
                const opts = [
                    ...classOrder.map(c => `<option value="${c}">${c}</option>`),
                    ...groupOrder.map(g => `<option value="${g}">${g}</option>`)
                ];
                filterSel.innerHTML += opts.join('');
            }

            const filterVal = filterSel ? filterSel.value : 'all';
            const filtered = relevant.filter(req => filterVal === 'all' || req.studentClass === filterVal || req.studentGroup === filterVal);

            if (filtered.length === 0) {
                list.innerHTML = `<div class="text-center p-4 text-muted">目前沒有待審核的申請</div>`;
            } else {
                list.innerHTML = filtered.map(req => `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="d-flex align-items-center mb-1">
                                <span class="fw-bold me-2">${req.studentName}</span>
                                <span class="badge bg-light text-secondary border me-2">${req.studentClass}/${req.studentGroup}</span>
                                <span class="badge bg-warning text-dark">${req.dayName || ''} ${req.sessionName}</span>
                            </div>
                            <div class="small">
                                <span class="text-muted">由 ${req.requesterName} 申請：</span>
                                <span class="text-decoration-line-through text-muted mx-1">${req.originStatus}</span>
                                <i class="bi bi-arrow-right mx-1"></i>
                                <span class="fw-bold text-danger">${req.newStatus}</span>
                            </div>
                            <div class="text-muted" style="font-size: 0.75rem;">${new Date(req.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-success btn-sm me-2" onclick="handleRequest('${req.id}', 'approve')">
                                <i class="bi bi-check-lg"></i> 批准
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="handleRequest('${req.id}', 'reject')">
                                <i class="bi bi-x-lg"></i> 駁回
                            </button>
                        </div>
                    </div>
            `).join('');
            }
            bootstrap.Modal.getOrCreateInstance(document.getElementById('approvalModal')).show();
        };

        window.batchHandleRequests = async (action) => {
            const relevant = getRelevantRequests();
            const filterVal = document.getElementById('approvalClassFilter') ? document.getElementById('approvalClassFilter').value : 'all';

            // Only process currently visible keys
            const toProcess = relevant.filter(req => filterVal === 'all' || req.studentClass === filterVal || req.studentGroup === filterVal);

            if (toProcess.length === 0) return alert("目前與篩選條件相符的申請為空");

            if (!confirm(`確定要全部 ${action === 'approve' ? '批准' : '駁回'} 共 ${toProcess.length} 筆申請嗎？`)) return;

            try {
                let count = 0;
                for (const req of toProcess) {
                    if (action === 'approve') {
                        const studentRef = doc(db, "students", req.studentId);
                        // Fix: Removed trailing space in key
                        await updateDoc(studentRef, { [`status.${req.targetSession}`]: req.newStatus });
                    }
                    await deleteDoc(doc(db, "requests", req.id));
                    count++;
                }
                // alert("批量操作完成");
                // refreshApprovalModal(); // Will be triggered by listener snapshot
            } catch (e) {
                console.error(e);
                alert("批量操作部分失敗: " + e.message);
            }
        };

        window.handleRequest = async (reqId, action) => {
            const req = pendingRequests.find(r => r.id === reqId);
            if (!req) return;

            if (!confirm(`確定要 ${action === 'approve' ? '批准' : '駁回'} ${req.studentName} 的申請嗎？`)) return;

            try {
                if (action === 'approve') {
                    // 1. Update Student Data
                    const studentRef = doc(db, "students", req.studentId);
                    // Fix: Removed trailing space in key
                    await updateDoc(studentRef, { [`status.${req.targetSession}`]: req.newStatus });

                    // 2. Delete Request
                    await deleteDoc(doc(db, "requests", reqId));
                } else {
                    // Reject: Just delete request
                    await deleteDoc(doc(db, "requests", reqId));
                }
            } catch (e) {
                console.error(e);
                alert("操作失敗: " + e.message);
            }
        };

        // Helper to refresh modal list if open
        window.refreshApprovalModal = () => {
            console.log("refreshApprovalModal called");
            const modalEl = document.getElementById('approvalModal');
            if (modalEl && modalEl.classList.contains('show')) {
                // Re-use logic from showApprovalModal but only update list
                const list = document.getElementById('approvalList');
                const relevant = getRelevantRequests();

                const filterSel = document.getElementById('approvalClassFilter');
                // Ensure options populated (should be already)
                if (filterSel && filterSel.options.length === 1) {
                    const opts = [
                        ...classOrder.map(c => `<option value="${c}">${c}</option>`),
                        ...groupOrder.map(g => `<option value="${g}">${g}</option>`)
                    ];
                    filterSel.innerHTML += opts.join('');
                }
                const filterVal = filterSel ? filterSel.value : 'all';
                console.log("Filter Value:", filterVal);

                // Safe trim just in case of whitespace
                const cleanFilterVal = filterVal.trim();

                const filtered = relevant.filter(req => {
                    if (cleanFilterVal === 'all') return true;
                    // Check both class and group
                    const sClass = (req.studentClass || '').trim();
                    const sGroup = (req.studentGroup || '').trim();
                    return sClass === cleanFilterVal || sGroup === cleanFilterVal;
                });

                if (filtered.length === 0) {
                    list.innerHTML = `<div class="text-center p-4 text-muted">目前沒有待審核的申請</div>`;
                } else {
                    list.innerHTML = filtered.map(req => `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="d-flex align-items-center mb-1">
                                <span class="fw-bold me-2">${req.studentName}</span>
                                <span class="badge bg-light text-secondary border me-2">${req.studentClass}/${req.studentGroup}</span>
                                <span class="badge bg-warning text-dark">${req.dayName || ''} ${req.sessionName}</span>
                            </div>
                            <div class="small">
                                <span class="text-muted">由 ${req.requesterName} 申請：</span>
                                <span class="text-decoration-line-through text-muted mx-1">${req.originStatus}</span>
                                <i class="bi bi-arrow-right mx-1"></i>
                                <span class="fw-bold text-danger">${req.newStatus}</span>
                            </div>
                            <div class="text-muted" style="font-size: 0.75rem;">${new Date(req.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-success btn-sm me-2" onclick="handleRequest('${req.id}', 'approve')">
                                <i class="bi bi-check-lg"></i> 批准
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="handleRequest('${req.id}', 'reject')">
                                <i class="bi bi-x-lg"></i> 駁回
                            </button>
                        </div>
                    </div>
            `).join('');
                }
            }
        };

        window.cancelRequest = async (reqId) => {
            if (!confirm("確定要取消此變更申請嗎？")) return;
            try {
                await deleteDoc(doc(db, "requests", reqId));
                // UI updates via snapshot
            } catch (e) {
                console.error(e);
                alert("取消失敗: " + e.message);
            }
        };

        window.initLogin = (studentId, studentName) => {
            if (currentUser) return; // Already logged in
            document.getElementById('loginTargetName').innerText = `登入：${studentName} `;
            document.getElementById('loginTargetName').dataset.id = studentId; // Restore missing ID setting
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').innerText = '';
            bootstrap.Modal.getOrCreateInstance(document.getElementById('loginModal')).show();
        };

        window.performLogin = async () => {
            const studentId = document.getElementById('loginTargetName').dataset.id;
            const password = document.getElementById('loginPassword').value;
            // Find student data
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;

            if (student.password === password) {
                currentUser = {
                    id: student.id,
                    name: student.name,
                    role: student.role || 'student',
                    class: student.class,
                    group: student.group
                };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                bootstrap.Modal.getOrCreateInstance(document.getElementById('loginModal')).hide();
                updateAuthUI();
                // Check if password is default
                if (password === '0000') {
                    setTimeout(() => {
                        if (confirm("您目前使用預設密碼，建議立即修改。是否前往修改？")) {
                            bootstrap.Modal.getOrCreateInstance(document.getElementById('changePasswordModal')).show();
                        }
                    }, 500);
                }
            } else {
                document.getElementById('loginError').innerText = "密碼錯誤";
            }
        };

        window.showAdminLogin = () => {
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminLoginError').innerText = '';
            bootstrap.Modal.getOrCreateInstance(document.getElementById('adminLoginModal')).show();
        };

        window.performAdminLogin = () => {
            const u = document.getElementById('adminUsername').value;
            const p = document.getElementById('adminPassword').value;

            const admins = [
                { u: 'admin', p: '31415926', name: '管理員', role: 'super_admin' },
                { u: '2-1', p: 'QAZwsx', name: '值星幹部', role: 'general_admin', customRoleTitle: '值星幹部' }
            ];

            const match = admins.find(a => a.u === u && a.p === p);

            if (match) {
                currentUser = {
                    id: match.u + '_admin_id',
                    name: match.name,
                    role: match.role,
                    customRoleTitle: match.customRoleTitle
                };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                bootstrap.Modal.getOrCreateInstance(document.getElementById('adminLoginModal')).hide();
                updateAuthUI();
            } else {
                document.getElementById('adminLoginError').innerText = "帳號或密碼錯誤";
            }
        };

        window.logout = () => {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            updateAuthUI();
        };

        window.submitChangePassword = async () => {
            if (!currentUser) return;
            const oldPass = document.getElementById('oldPass').value;
            const newPass = document.getElementById('newPass').value;
            const confirmPass = document.getElementById('confirmPass').value;

            if (newPass !== confirmPass) { alert("兩次新密碼輸入不一致"); return; }
            if (newPass.length < 4) { alert("密碼太短，請至少輸入4位數"); return; }

            // Super admin special update
            if (currentUser.role === 'super_admin') {
                alert("超級管理員密碼請由後台修改");
                return;
            }

            // Verify old password by fetching latest data
            const docRef = doc(db, "students", currentUser.id);
            const docSnap = await getDocs(query(studentsRef)); // Inefficient but works, better to use getDoc if possible but we have studentsData
            // Use local check first then overwrite
            const student = studentsData.find(s => s.id === currentUser.id);
            if (student.password !== oldPass) {
                alert("舊密碼錯誤");
                return;
            }

            try {
                await updateDoc(docRef, { password: newPass });
                alert("密碼修改成功！");
                bootstrap.Modal.getOrCreateInstance(document.getElementById('changePasswordModal')).hide();
            } catch (e) {
                console.error(e);
                alert("修改失敗");
            }
        };

        // Initial check
        window.addEventListener('load', () => {
            updateAuthUI();
        });

        // Note: other functions like addStudent, removeStudent are already assigned to window directly above.

        function setGroupBy(mode) {
            currentGroupMode = mode;
            renderAll();
        }

        function getStatusBadge(s) {
            if (s === '實到') return '<span class="badge bg-success">實到</span>';
            if (s === '缺席') return '<span class="badge bg-danger">缺席</span>';
            if (s === '遲到') return '<span class="badge bg-warning text-dark">遲到</span>';
            return `<span class="badge bg-info text-dark">${s}</span>`;
        }
        // Search Filtering
        function filterStudents() {
            const term = document.getElementById('searchInput').value.toLowerCase();

            // Search logic:
            // 1. If term matches Card Header (Class/Group Name), show the whole card and all rows.
            // 2. If term matches Student Name, show that row (and its parent card).
            // 3. Otherwise hide.

            const cards = document.querySelectorAll('#classContainer .card');
            cards.forEach(card => {
                const headerText = card.querySelector('.class-header').innerText.toLowerCase();
                const cardMatchesHeader = headerText.includes(term);

                const rows = card.querySelectorAll('tbody tr');
                let hasVisibleRow = false;

                rows.forEach(row => {
                    const name = row.querySelector('.fw-bold').innerText.toLowerCase();
                    const classGroup = row.querySelector('.badge').innerText.toLowerCase(); // Getting Class/Group text from row badge

                    // Match against: Name OR Class/Group Badge OR (Parent Card Header if matched)
                    if (cardMatchesHeader || name.includes(term) || classGroup.includes(term)) {
                        row.classList.remove('d-none');
                        hasVisibleRow = true;
                    } else {
                        row.classList.add('d-none');
                    }
                });

                // Visibility of the Card itself
                if (hasVisibleRow) {
                    card.parentElement.classList.remove('d-none');
                } else {
                    card.parentElement.classList.add('d-none');
                }
            });
        }

        function getStatusColorClass(s) {
            if (!s || s === '實到') return "text-success border-success bg-white";
            if (s === '缺席') return "text-danger border-danger bg-white";
            if (s === '遲到') return "text-warning border-warning bg-white";
            return "text-secondary border-secondary bg-white";
        }
        function getNameColorClass(s) {
            if (!s || s === '實到') return "text-primary";
            return "text-danger fw-bolder";
        }
        window.migrateOldClasses = async () => {
            if (!confirm("確定要執行「舊班級名稱 -> 新班級名稱」的資料遷移嗎？\n此操作將會更新所有學生的班級欄位。")) return;

            const mapping = {
                "一班": "01班", "二班": "02班", "三班": "03班", "四班": "04班",
                "五班": "05班", "六班": "06班", "七班": "07班", "八班": "08班",
                "九班": "09班", "十班": "10班", "十一班": "11班", "十二班": "12班"
            };

            let updateCount = 0;
            const updates = [];

            studentsData.forEach(s => {
                if (mapping[s.class]) {
                    const newClass = mapping[s.class];
                    // console.log(`Migrating ${ s.name }: ${ s.class } -> ${ newClass } `);
                    updates.push(updateDoc(doc(db, "students", s.id), { class: newClass }));
                    updateCount++;
                }
            });

            if (updateCount === 0) {
                alert("沒有發現需要遷移的資料。");
                return;
            }

            try {
                await Promise.all(updates);
                alert(`遷移完成！共更新了 ${updateCount} 筆資料。\n請重新整理網頁。`);
                location.reload();
            } catch (e) {
                console.error(e);
                alert("遷移過程發生錯誤：" + e.message);
            }
        };

        function renderStatusSettings() {
            const canManage = currentUser && ['super_admin', 'general_admin', 'class_admin', 'group_admin'].includes(currentUser.role);
            const isSuperOrGeneral = currentUser && ['super_admin', 'general_admin'].includes(currentUser.role);

            const addContainer = document.getElementById('addStatusContainer');
            if (addContainer) {
                if (canManage) addContainer.classList.remove('d-none');
                else addContainer.classList.add('d-none');
            }

            let html = currentStatuses.map(s => `
            <div class="custom-status-tag border rounded px-2 py-1 bg-light">${s} ${(s !== '實到' && canManage) ? `<span role="button" class="text-danger ms-2 fw-bold" onclick="removeStatusType('${s}')">&times;</span>` : ''}</div>
            `).join('');

            document.getElementById('statusListContainer').innerHTML = html;
        }

        // Enable Drag to Scroll & Wheel to Scroll
        function enableDragScroll(id) {
            const slider = document.getElementById(id);
            let isDown = false;
            let startX;
            let scrollLeft;

            slider.addEventListener('mousedown', (e) => {
                isDown = true;
                slider.classList.add('active');
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });
            slider.addEventListener('mouseleave', () => {
                isDown = false;
                slider.classList.remove('active');
            });
            slider.addEventListener('mouseup', () => {
                isDown = false;
                slider.classList.remove('active');
            });
            slider.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 2; // Scroll-fast
                slider.scrollLeft = scrollLeft - walk;
            });
            // Convert vertical wheel to horizontal scroll
            slider.addEventListener('wheel', (e) => {
                if (e.deltaY !== 0) {
                    e.preventDefault();
                    slider.scrollLeft += e.deltaY;
                }
            });
        }

        // Initialize scroll features
        enableDragScroll('weekTabs');
        enableDragScroll('sessionTabs');

        // --- Quick Status Feature ---

        window.openQuickStatusModal = () => {
            if (!currentUser) return alert("請先登入！");

            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('quickStatusModal'));
            const targetClassContainer = document.getElementById('qsTargetClassContainer');
            const targetStudentContainer = document.getElementById('qsTargetStudentContainer');
            const dateContainer = document.getElementById('qsDateContainer');
            const sessionContainer = document.getElementById('qsSessionContainer');
            const statusSelect = document.getElementById('qsStatusSelect');

            // Reset UI
            targetClassContainer.classList.add('d-none');
            targetStudentContainer.classList.add('d-none');
            document.getElementById('qsTargetClass').innerHTML = '<option value="">請選擇班級</option>';
            document.getElementById('qsTargetStudent').innerHTML = '<option value="">請選擇學生</option>';
            dateContainer.innerHTML = '';
            sessionContainer.innerHTML = '';
            statusSelect.innerHTML = '<option value="">請選擇狀態</option>';

            // 1. Setup Target Selection based on Role
            if (currentUser.role === 'student') {
                // Student: Target is self (Hidden)
            } else if (currentUser.role === 'class_admin' || currentUser.role === 'group_admin') {
                // Class/Group Admin: Show Student Select (Filtered Scope)
                targetStudentContainer.classList.remove('d-none');
                updateQuickStatusStudentList(
                    currentUser.role === 'class_admin' ? 'class' : 'group',
                    currentUser.role === 'class_admin' ? currentUser.class : currentUser.group
                );
            } else {
                // Super/General/Duty Admin: Show Class + Student Select
                targetClassContainer.classList.remove('d-none');
                targetStudentContainer.classList.remove('d-none');

                // Populate Class Select with all unique classes
                // Use classOrder for sorting
                const classes = [...new Set(studentsData.map(s => s.class))].sort((a, b) => {
                    const idxA = classOrder.indexOf(a);
                    const idxB = classOrder.indexOf(b);
                    if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                    return a.localeCompare(b);
                });

                document.getElementById('qsTargetClass').innerHTML =
                    `<option value="">請選擇班級</option>` +
                    classes.map(c => `<option value="${c}">${c}</option>`).join('');
            }

            // 2. Populate Date Checkboxes
            const daysOfWeek = ['星期一', '星期二', '星期三', '星期四', '星期五', '星期六', '星期日'];
            dateContainer.innerHTML = daysOfWeek.map(d => `
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" name="qsDay" value="${d}" id="qsDay_${d}">
                    <label class="form-check-label" for="qsDay_${d}">${d}</label>
                </div>
            `).join('');

            // 3. Populate Session Checkboxes
            sessionContainer.innerHTML = sessions.map(s => `
                <div class="form-check form-check-inline mb-2">
                    <input class="form-check-input" type="checkbox" name="qsSession" value="${s}" id="qsSession_${s}">
                    <label class="form-check-label" for="qsSession_${s}">${s}</label>
                </div>
            `).join('');

            // 4. Populate Status Dropdown
            statusSelect.innerHTML =
                `<option value="">請選擇狀態</option>` +
                currentStatuses.map(s => `<option value="${s}">${stripStatusHtml(s)}</option>`).join('');

            modal.show();
        };

        window.updateQuickStatusStudentList = (scopeType, scopeValue) => {
            // scopeType: 'class' (from dropdown or user role) or 'group'
            // scopeValue: class name or group name

            if (!scopeValue) {
                document.getElementById('qsTargetStudent').innerHTML = '<option value="">請選擇學生</option>';
                return;
            }

            const filteredStudents = studentsData.filter(s => {
                if (scopeType === 'class') return s.class === scopeValue;
                if (scopeType === 'group') return s.group === scopeValue;
                return false;
            }).sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));

            document.getElementById('qsTargetStudent').innerHTML =
                `<option value="">請選擇學生</option>` +
                filteredStudents.map(s => `<option value="${s.id}">${s.name} (${s.group || '-'})</option>`).join('');
        };

        window.submitQuickStatus = async () => {
            // 1. Gather Data
            const selectedDays = Array.from(document.querySelectorAll('input[name="qsDay"]:checked')).map(cb => cb.value);
            const selectedSessions = Array.from(document.querySelectorAll('input[name="qsSession"]:checked')).map(cb => cb.value);
            const selectedStatus = document.getElementById('qsStatusSelect').value;

            // 2. Validation
            if (selectedDays.length === 0) return alert("請至少選擇一個日期");
            if (selectedSessions.length === 0) return alert("請至少選擇一個時段");
            if (!selectedStatus) return alert("請選擇差勤狀態");

            let targetId = null;
            let targetName = "";

            // Identify Target Logic
            if (currentUser.role === 'student') {
                targetId = currentUser.id;
                targetName = currentUser.name;
            } else {
                targetId = document.getElementById('qsTargetStudent').value;
                if (!targetId) return alert("請選擇目標學生");
                const tStudent = studentsData.find(s => s.id === targetId);
                targetName = tStudent ? tStudent.name : "未知";
            }

            if (!confirm(`確定要將 ${targetName} 在 ${selectedDays.length} 個日期、${selectedSessions.length} 個時段的狀態設為「${selectedStatus}」嗎？`)) return;

            // 3. Execution
            try {
                const isRequestMode = (currentUser.role === 'student');
                // Note: Prompt implies Admins can directly update. Students initiate requests.

                const updates = [];

                if (isRequestMode) {
                    // Request Mode: Create multiple requests
                    for (const day of selectedDays) {
                        for (const session of selectedSessions) {
                            const targetKey = `${day}_${session}`;
                            const reqData = {
                                studentId: targetId,
                                studentName: targetName,
                                studentClass: currentUser.class,
                                studentGroup: currentUser.group,
                                requesterId: currentUser.id,
                                requesterName: currentUser.name,
                                dayName: day,
                                sessionName: session,
                                targetSession: targetKey,
                                originStatus: "未知", // Batch implies we might overwrite diverse statuses
                                newStatus: selectedStatus,
                                status: 'pending',
                                timestamp: new Date().toISOString()
                            };
                            updates.push(addDoc(collection(db, "requests"), reqData));
                        }
                    }
                    await Promise.all(updates);
                    alert(`已送出 ${updates.length} 筆差勤申請，請通知幹部審核。`);

                } else {
                    // Direct Update Mode: Single updateDoc with multiple fields
                    const statusUpdates = {};
                    for (const day of selectedDays) {
                        for (const session of selectedSessions) {
                            statusUpdates[`status.${day}_${session}`] = selectedStatus;
                        }
                    }

                    await updateDoc(doc(db, "students", targetId), statusUpdates);
                    alert(`更新成功！`);
                }

                bootstrap.Modal.getOrCreateInstance(document.getElementById('quickStatusModal')).hide();

            } catch (e) {
                console.error(e);
                alert("操作失敗: " + e.message);
            }
        };

    </script>
</body>

<!-- Quick Status Modal -->
<div class="modal fade" id="quickStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-lightning-fill me-2"></i>快速差勤設定</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Target Selection -->
                <div id="qsTargetClassContainer" class="mb-3 d-none">
                    <label class="form-label fw-bold">選擇班級</label>
                    <select id="qsTargetClass" class="form-select"
                        onchange="updateQuickStatusStudentList('class', this.value)"></select>
                </div>
                <div id="qsTargetStudentContainer" class="mb-3 d-none">
                    <label class="form-label fw-bold">選擇學生</label>
                    <select id="qsTargetStudent" class="form-select"></select>
                </div>

                <!-- Date Selection -->
                <div class="mb-3">
                    <label class="form-label fw-bold">選擇日期 (可多選)</label>
                    <div id="qsDateContainer" class="border rounded p-2 bg-light"></div>
                </div>

                <!-- Session Selection -->
                <div class="mb-3">
                    <label class="form-label fw-bold">選擇時段 (可多選)</label>
                    <div id="qsSessionContainer" class="border rounded p-2 bg-light"></div>
                </div>

                <!-- Status Selection -->
                <div class="mb-3">
                    <label class="form-label fw-bold">設定差勤狀態</label>
                    <select id="qsStatusSelect" class="form-select"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitQuickStatus()">確認送出</button>
            </div>
        </div>
    </div>
</div>


</html>