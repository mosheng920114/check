<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多人協作點名系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .stat-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .class-header {
            background: linear-gradient(45deg, #2193b0, #6dd5ed);
            color: white;
            border-radius: 10px 10px 0 0;
            padding: 15px;
            font-weight: bold;
        }

        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .custom-status-tag {
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
        }

        .nav-pills .nav-link {
            border-radius: 20px;
            margin-right: 5px;
            color: #555;
            background: #fff;
            border: 1px solid #ddd;
            word-break: keep-all;
        }

        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .nav-scroller {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 10px;
        }

        @media (max-width: 768px) {
            .class-header {
                border-radius: 12px 12px 0 0;
            }

            .table thead {
                display: none;
            }

            .table,
            .table tbody,
            .table tr,
            .table td {
                display: block;
                width: 100%;
            }

            .table tr {
                margin-bottom: 15px;
                background: #fff;
                border: 1px solid #eee;
                border-radius: 8px;
                padding: 10px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            }

            .table td {
                text-align: left;
                padding: 8px 5px;
                border: none;
            }

            .table td:last-child {
                border-top: 1px solid #f0f0f0;
                margin-top: 5px;
                padding-top: 10px;
                text-align: right;
            }

            .btn-group {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
            }

            .btn-group .btn {
                flex: 1 1 auto;
                margin: 0;
                border-radius: 5px !important;
                margin-bottom: 3px;
            }
        }
    </style>
</head>

<body class="p-3">
    <div class="container-fluid" style="max-width: 1400px;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="fw-bold text-primary"><i class="bi bi-pencil-square"></i> 多人協作點名系統</h2>
            <div class="d-flex align-items-center gap-3">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="groupBy" id="groupByClass" autocomplete="off" checked
                        onchange="setGroupBy('class')">
                    <label class="btn btn-outline-primary" for="groupByClass">依班級</label>
                    <input type="radio" class="btn-check" name="groupBy" id="groupByGroup" autocomplete="off"
                        onchange="setGroupBy('group')">
                    <label class="btn btn-outline-primary" for="groupByGroup">依組別</label>
                </div>
                <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                    <i class="bi bi-person-plus-fill"></i> 新增人員
                </button>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                    <i class="bi bi-gear-fill"></i> 設定差勤
                </button>
            </div>
        </div>

        <div class="nav-scroller mb-2">
            <nav class="nav nav-pills" id="weekTabs"></nav>
        </div>

        <div class="nav-scroller mb-3">
            <nav class="nav nav-pills" id="sessionTabs"></nav>
        </div>

        <div class="row mb-4">
            <div class="col-12">
                <div class="stat-card border-start border-5 border-primary">
                    <div class="row mb-3 align-items-center">
                        <div class="col-md-6">
                            <h5 class="mb-0">
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="copyGlobalReport()">
                                    <i class="bi bi-clipboard"></i> 複製總覽(當下)
                                </button>
                                總覽 <small class="text-muted" id="currentSessionLabel"></small>
                            </h5>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-4 align-items-center" id="globalStatsPanel">
                        <span class="spinner-border spinner-border-sm" role="status"></span> 載入統計中...
                    </div>
                </div>
            </div>
        </div>



        <div id="classContainer" class="row g-4">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">連線中...</p>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增人員</h5>
                    <button type="button" class="btn-primary btn-sm ms-auto me-2 btn" data-bs-toggle="modal"
                        data-bs-target="#batchAddModal">批量新增</button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="form-floating"><input type="text" id="inputClass" class="form-control"
                                    placeholder="班級"><label for="inputClass">班級 (例: 101)</label></div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating"><input type="text" id="inputGroup" class="form-control"
                                    placeholder="組別"><label for="inputGroup">組別 (例: A組)</label></div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating"><input type="text" id="inputName" class="form-control"
                                    placeholder="姓名"><label for="inputName">姓名</label></div>
                        </div>
                        <div class="col-12 text-end">
                            <button onclick="addStudent()" class="btn btn-primary btn-lg w-100 shadow-sm"><i
                                    class="bi bi-plus-lg"></i> 確定新增</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">差勤狀態設定</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3"><input type="text" id="newStatusInput" class="form-control"
                            placeholder="輸入新狀態名稱"><button class="btn btn-primary"
                            onclick="addNewStatusType()">新增</button></div>
                    <hr>
                    <h6>目前可用狀態:</h6>
                    <div id="statusListContainer" class="d-flex flex-wrap"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="batchAddModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量新增學生</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small">格式：<strong>班級 組別 姓名</strong> (中間空白)<br>範例：<br>101 A組 王小明</div>
                    <textarea id="batchInput" class="form-control" rows="10" placeholder="101 A組 王小明"></textarea>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">取消</button><button type="button" class="btn btn-primary"
                        onclick="batchAddStudents()">開始匯入</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyACL_67nXJU6RZEf3InFqHQJ-5h6FMZ7t8",
            authDomain: "check-74ee8.firebaseapp.com",
            projectId: "check-74ee8",
            storageBucket: "check-74ee8.firebasestorage.app",
            messagingSenderId: "795590503656",
            appId: "1:795590503656:web:f68019efd5eb88aa51ed5d",
            measurementId: "G-QMBN11NQ34"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const studentsRef = collection(db, "students");
        const configRef = doc(db, "settings", "globalConfig");

        const sessions = ["早點名", "早上上餐廳", "0740集合", "中午上餐廳", "1320集合", "晚上上餐廳", "晚自習", "晚點名", "備用點名"];
        const days = ["星期一", "星期二", "星期三", "星期四", "星期五", "星期六", "星期日"];

        let currentSession = sessions[0];
        let currentDay = days[0];
        let currentGroupMode = "class";
        let currentStatuses = ["實到", "遲到", "缺席"];
        let studentsData = [];

        // 初始化
        initWeekTabs();
        initSessionTabs();

        // 功能: 複製
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => alert("已複製到剪貼簿！"))
                    .catch(err => fallbackCopyTextToClipboard(text));
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                var successful = document.execCommand('copy');
                var msg = successful ? '已複製到剪貼簿！' : '複製失敗';
                alert(msg);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                alert("複製失敗 (瀏覽器不支援)");
            }
            document.body.removeChild(textArea);
        }

        function getStatusKey(session) {
            return `${currentDay}_${session}`;
        }

        function generateReportText(scope, groupName = null, specifiedSession = null) {
            let output = "";
            const targetSessions = specifiedSession ? [specifiedSession] : sessions;

            if (scope === 'all') {
                targetSessions.forEach(session => {
                    const statusKey = getStatusKey(session);
                    const stats = { '實到': 0 };
                    const detailList = {};
                    currentStatuses.forEach(s => { if (s !== '實到') detailList[s] = []; });
                    let total = 0;

                    studentsData.forEach(s => {
                        total++;
                        const status = (s.status && s.status[statusKey]) ? s.status[statusKey] : '實到';
                        if (status === '實到') stats['實到']++;
                        else {
                            if (!detailList[status]) detailList[status] = [];
                            detailList[status].push(s.name);
                        }
                    });

                    output += `應到:${total}\n`;
                    output += `事故：\n`;
                    Object.entries(detailList).forEach(([status, names]) => {
                        if (names.length > 0) {
                            output += `${status}${names.length} ${names.join(' ')}\n`;
                        }
                    });
                    output += `實到：${stats['實到']}\n\n`;
                });
                return output;
            }

            let targetGroups = [groupName];
            targetGroups.forEach(gName => {
                output += `${gName}\n\n`;
                targetSessions.forEach(session => {
                    const groupStudents = studentsData.filter(s => {
                        const sGroup = currentGroupMode === 'class' ? s.class : (s.group || '未分組');
                        return sGroup === gName;
                    });
                    if (groupStudents.length === 0) return;
                    const total = groupStudents.length;
                    const statusKey = getStatusKey(session);
                    const stats = { '實到': 0 };
                    const detailList = {};
                    currentStatuses.forEach(s => { if (s !== '實到') detailList[s] = []; });

                    groupStudents.forEach(s => {
                        const status = (s.status && s.status[statusKey]) ? s.status[statusKey] : '實到';
                        if (status === '實到') stats['實到']++;
                        else {
                            if (!detailList[status]) detailList[status] = [];
                            detailList[status].push(s.name);
                        }
                    });

                    output += `${session}\n應到${total}\n事故：\n`;
                    Object.entries(detailList).forEach(([status, names]) => {
                        if (names.length > 0) output += `${status}${names.length} ${names.join(' ')}\n`;
                    });
                    output += `實到：${stats['實到']}\n\n`;
                });
                output += `------------------\n\n`;
            });
            return output;
        }

        onSnapshot(configRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                if (data.statuses && Array.isArray(data.statuses)) {
                    currentStatuses = data.statuses;
                    renderStatusSettings();
                    renderAll();
                }
            } else {
                setDoc(configRef, { statuses: ["實到", "遲到", "缺席", "病假", "事假", "公假"] });
            }
        });

        const q = query(studentsRef);
        onSnapshot(q, (snapshot) => {
            studentsData = [];
            snapshot.forEach((doc) => studentsData.push({ id: doc.id, ...doc.data() }));
            studentsData.sort((a, b) => {
                if (a.class !== b.class) return a.class.localeCompare(b.class);
                return (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0);
            });
            try { renderAll(); } catch (err) { console.error(err); }
        });

        function initWeekTabs() {
            const container = document.getElementById('weekTabs');
            container.innerHTML = days.map(day => `
                <a class="nav-link ${day === currentDay ? 'active' : ''} fw-bold" 
                   href="#" onclick="changeDay('${day}')">${day}</a>
            `).join('');
        }

        function initSessionTabs() {
            const container = document.getElementById('sessionTabs');
            container.innerHTML = sessions.map(session => `
                <a class="nav-link ${session === currentSession ? 'active' : ''}" href="#" onclick="changeSession('${session}')">${session}</a>
            `).join('');
        }

        function renderAll() {
            const container = document.getElementById('classContainer');
            const globalStatsPanel = document.getElementById('globalStatsPanel');
            document.getElementById('currentSessionLabel').innerText = `(${currentDay} - ${currentSession})`;
            container.innerHTML = ""; globalStatsPanel.innerHTML = "";

            const grouped = {};
            const globalStats = { total: 0, byStatus: {} };
            currentStatuses.forEach(s => globalStats.byStatus[s] = 0);

            studentsData.forEach(student => {
                let key = currentGroupMode === 'class' ? student.class : student.group;
                if (!key) key = "未分組";
                if (!grouped[key]) {
                    grouped[key] = { students: [], stats: { total: 0, byStatus: {} } };
                    currentStatuses.forEach(s => grouped[key].stats.byStatus[s] = 0);
                }
                grouped[key].students.push(student);

                // Use Composite Key
                const statusKey = getStatusKey(currentSession);
                let status = "實到";
                if (student.status && student.status[statusKey]) status = student.status[statusKey];
                student._currentStatus = status;

                grouped[key].stats.total++;
                if (grouped[key].stats.byStatus[status] !== undefined) grouped[key].stats.byStatus[status]++;

                globalStats.total++;
                if (globalStats.byStatus[status] !== undefined) globalStats.byStatus[status]++;
            });

            // Global Stats
            let globalStatsHtml = `<div class="d-flex align-items-baseline me-4"><span class="text-muted small me-2">應到總數</span><span class="fs-4 fw-bold text-dark">${globalStats.total}</span></div>`;
            globalStatsHtml += `<div class="d-flex align-items-baseline me-4"><span class="text-muted small me-2">實到</span><span class="fs-4 fw-bold text-success">${globalStats.byStatus['實到'] || 0}</span></div>`;
            let breakdownHtml = "";
            Object.entries(globalStats.byStatus).forEach(([status, count]) => {
                if (status !== '實到' && count > 0) breakdownHtml += `<span class="me-3 text-danger">${status}: <b>${count}</b></span>`;
            });
            globalStatsPanel.innerHTML = globalStatsHtml + `<div class="border-start ps-3 ms-2">${breakdownHtml}</div>`;

            if (Object.keys(grouped).length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted py-5">目前沒有資料，請從上方新增。</div>`;
                return;
            }

            Object.keys(grouped).sort().forEach(groupName => {
                const group = grouped[groupName];
                let classStatStr = `應到: ${group.stats.total} | 實到: ${group.stats.byStatus['實到'] || 0}`;

                const rows = group.students.map(student => `
                    <tr>
                        <td><span class="fw-bold text-primary">${student.name}</span><br><span class="badge bg-light text-secondary border">${student.class} / ${student.group || '-'}</span></td>
                        <td>${getStatusBadge(student._currentStatus)}</td>
                        <td>
                            <select class="form-select form-select-sm fw-bold ${getStatusColorClass(student._currentStatus)}" onchange="updateStatus('${student.id}', this.value)" style="min-width: 110px;">
                                ${currentStatuses.map(s => `<option value="${s}" ${student._currentStatus === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </td>
                        <td class="text-end"><button class="btn btn-sm btn-light text-danger" onclick="removeStudent('${student.id}')"><i class="bi bi-trash"></i></button></td>
                    </tr>
                `).join('');

                const card = `
                    <div class="col-xl-6 col-12">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="class-header d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <span class="fs-5 me-2"><i class="bi bi-house-door-fill me-2"></i>${groupName}</span>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-link text-white p-0" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="copyToClipboard(generateReportText('group', '${groupName}', '${currentSession}'))">複製本班 (當下時段)</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="copyToClipboard(generateReportText('group', '${groupName}', null))">複製本班 (全部時段)</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <span class="badge bg-light text-dark opacity-75 fw-normal fs-6">${classStatStr}</span>
                            </div>
                            <div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th style="width: 25%">姓名</th><th style="width: 15%">狀態</th><th>操作</th><th style="width: 10%"></th></tr></thead><tbody>${rows}</tbody></table></div></div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        window.changeDay = (day) => { currentDay = day; initWeekTabs(); renderAll(); };
        window.changeSession = (n) => { currentSession = n; initSessionTabs(); renderAll(); };
        window.setGroupBy = (m) => { currentGroupMode = m; renderAll(); };
        window.addStudent = async () => {
            const classInput = document.getElementById('inputClass').value.trim();
            const groupInput = document.getElementById('inputGroup').value.trim();
            const nameInput = document.getElementById('inputName').value.trim();
            if (!classInput || !nameInput) return alert("請輸入班級和姓名");
            try {
                await addDoc(studentsRef, { class: classInput, group: groupInput || "無", name: nameInput, status: {}, timestamp: new Date() });
                document.getElementById('inputName').value = '';
            } catch (e) { console.error(e); alert("新增失敗"); }
        };
        window.batchAddStudents = async () => {
            const input = document.getElementById('batchInput').value.trim();
            if (!input) return;
            const lines = input.split('\n');
            const promises = [];
            for (let line of lines) {
                line = line.trim();
                const parts = line.split(/\s+/);
                if (parts.length < 3) continue;
                promises.push(addDoc(studentsRef, { class: parts[0], group: parts[1], name: parts.slice(2).join(' '), status: {}, timestamp: new Date() }));
            }
            try {
                await Promise.all(promises);
                alert("匯入成功！");
                bootstrap.Modal.getOrCreateInstance(document.getElementById('batchAddModal')).hide();
                document.getElementById('batchInput').value = '';
            } catch (e) { console.error(e); alert("匯入失敗"); }
        };
        window.updateStatus = async (id, val) => {
            const statusKey = getStatusKey(currentSession);
            await updateDoc(doc(db, "students", id), { [`status.${statusKey}`]: val });
        };
        window.removeStudent = async (id) => { if (confirm('確定刪除？')) await deleteDoc(doc(db, "students", id)); };
        window.addNewStatusType = async () => {
            const val = document.getElementById('newStatusInput').value.trim();
            if (!val || currentStatuses.includes(val)) return;
            await updateDoc(configRef, { statuses: [...currentStatuses, val] });
            document.getElementById('newStatusInput').value = '';
        };
        window.removeStatusType = async (val) => {
            if (confirm(`移除 ${val}?`)) await updateDoc(configRef, { statuses: currentStatuses.filter(s => s !== val) });
        };
        window.copyToClipboard = copyToClipboard;
        window.generateReportText = generateReportText;
        window.copyGlobalReport = () => copyToClipboard(generateReportText('all', null, currentSession));

        function getStatusBadge(s) {
            if (s === '實到') return '<span class="badge bg-success">實到</span>';
            if (s === '缺席') return '<span class="badge bg-danger">缺席</span>';
            if (s === '遲到') return '<span class="badge bg-warning text-dark">遲到</span>';
            return `<span class="badge bg-info text-dark">${s}</span>`;
        }
        function getStatusColorClass(s) {
            if (!s || s === '實到') return "text-success border-success bg-white";
            if (s === '缺席') return "text-danger border-danger bg-white";
            if (s === '遲到') return "text-warning border-warning bg-white";
            return "text-secondary border-secondary bg-white";
        }
        function renderStatusSettings() {
            document.getElementById('statusListContainer').innerHTML = currentStatuses.map(s => `
                <div class="custom-status-tag border rounded px-2 py-1 bg-light">${s} ${s !== '實到' ? `<span role="button" class="text-danger ms-2 fw-bold" onclick="removeStatusType('${s}')">&times;</span>` : ''}</div>
            `).join('');
        }
    </script>
</body>

</html>