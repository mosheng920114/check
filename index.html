<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多人協作點名系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .stat-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .class-header {
            background: linear-gradient(45deg, #2193b0, #6dd5ed);
            color: white;
            border-radius: 10px 10px 0 0;
            padding: 15px;
            font-weight: bold;
        }

        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .custom-status-tag {
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
        }

        .nav-pills .nav-link {
            border-radius: 20px;
            margin-right: 5px;
            color: #555;
            background: #fff;
            border: 1px solid #ddd;
            word-break: keep-all;
        }

        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }

        .nav-scroller {
            overflow-x: auto;
            white-space: nowrap;
            padding-bottom: 10px;
        }

        @media (max-width: 768px) {
            .class-header {
                border-radius: 12px 12px 0 0;
            }

            /* Table styles removed to match desktop view */
        }

        /* New Scroll Container for Mobile Tabs */
        .scroll-container {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 5px;
            margin-bottom: 10px;
            gap: 8px;
        }

        .scroll-container::-webkit-scrollbar {
            height: 4px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
        }

        /* Header Optimization */
        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (max-width: 576px) {
            .header-top {
                flex-direction: column;
                align-items: flex-start !important;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }

            .header-actions .btn-group,
            .header-actions .btn {
                flex: 1;
            }
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-3" style="max-width: 1000px;">
        <!-- Top Bar -->
        <div class="d-flex justify-content-between align-items-center mb-3 header-top">
            <h2 class="fw-bold text-primary m-0 d-flex align-items-center">
                <i class="bi bi-pencil-square me-2"></i>點名系統
            </h2>
            <div class="header-actions">
                <!-- Right Side: Settings & Add -->
                <div class="d-flex align-items-center flex-wrap">
                    <button id="adminLoginBtn" class="btn btn-outline-primary me-1 me-md-2" onclick="showAdminLogin()"
                        title="管理員登入">
                        <i class="bi bi-key-fill"></i>
                    </button>
                    <div id="userInfoDisplay" class="d-none align-items-center me-1 me-md-2">
                        <!-- Notification Bell (Hidden by default) -->
                        <button id="notificationBtn" class="btn btn-outline-warning position-relative me-2 d-none"
                            onclick="showApprovalModal()">
                            <i class="bi bi-bell-fill"></i>
                            <span id="notificationBadge"
                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                                0
                                <span class="visually-hidden">unread messages</span>
                            </span>
                        </button>

                        <!-- User Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-outline-primary dropdown-toggle fw-bold" type="button"
                                id="userMenuBtn" data-bs-toggle="dropdown">
                                <span id="userNameDisplay"></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal"
                                        data-bs-target="#changePasswordModal"><i class="bi bi-key me-2"></i>更改密碼</a>
                                </li>
                                <li><a class="dropdown-item d-none" id="adminManageLink" href="#"
                                        onclick="showAdminDashboard()"><i class="bi bi-people-fill me-2"></i>人員權限管理</a>
                                </li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i
                                            class="bi bi-box-arrow-right me-2"></i>登出</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="btn-group me-1 me-md-2" role="group">
                        <button class="btn btn-outline-primary px-2 px-md-3 text-nowrap"
                            onclick="setGroupBy('class')">依班級</button>
                        <button class="btn btn-outline-primary px-2 px-md-3 text-nowrap"
                            onclick="setGroupBy('group')">依組別</button>
                    </div>

                    <button id="addStudentBtn" class="btn btn-outline-primary me-1 me-md-2"
                        onclick="showAddStudentModal()">
                        <i class="bi bi-person-plus-fill me-1"></i><span class="d-none d-sm-inline">新增</span>
                    </button>
                    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                        <i class="bi bi-gear-fill"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Week Tabs (Scrollable) -->
        <div id="weekTabs" class="scroll-container mb-3">
            <!-- JS Generated -->
        </div>

        <!-- Session Tabs (Scrollable) -->
        <div id="sessionTabs" class="scroll-container mb-3">
            <!-- JS Generated -->
        </div>

        <!-- Search Bar -->
        <div class="row mb-3 gx-2 align-items-center">
            <div class="col">
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
                    <input type="search" id="searchInput" class="form-control border-start-0" placeholder="搜尋學生姓名..."
                        oninput="filterStudents()">
                </div>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-12">
                <div class="stat-card border-start border-5 border-primary">
                    <div class="row mb-3 align-items-center">
                        <div class="col-12">
                            <h5 class="mb-0 d-flex align-items-center flex-wrap">
                                總覽 <small class="text-muted mx-2" id="currentSessionLabel"></small>
                                <button class="btn btn-outline-primary btn-sm ms-auto" onclick="copyGlobalReport()">
                                    <i class="bi bi-clipboard"></i> 複製總覽
                                </button>
                            </h5>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-4 align-items-center" id="globalStatsPanel">
                        <span class="spinner-border spinner-border-sm" role="status"></span> 載入統計中...
                    </div>
                </div>
            </div>
        </div>



        <div id="classContainer" class="row g-4">
            <div class="col-12 text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">連線中...</p>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增人員</h5>
                    <button type="button" class="btn-primary btn-sm ms-auto me-2 btn" data-bs-toggle="modal"
                        data-bs-target="#batchAddModal">批量新增</button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="form-floating"><input type="text" id="inputClass" class="form-control"
                                    placeholder="班級"><label for="inputClass">班級 (例: 101)</label></div>
                        </div>
                        <div class="col-6">
                            <div class="form-floating"><input type="text" id="inputGroup" class="form-control"
                                    placeholder="組別"><label for="inputGroup">組別 (例: A組)</label></div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating"><input type="text" id="inputName" class="form-control"
                                    placeholder="姓名"><label for="inputName">姓名</label></div>
                        </div>
                        <div class="col-12 text-end">
                            <button onclick="addStudent()" class="btn btn-primary btn-lg w-100 shadow-sm"><i
                                    class="bi bi-plus-lg"></i> 確定新增</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">差勤狀態設定</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="addStatusContainer" class="input-group mb-3"><input type="text" id="newStatusInput"
                            class="form-control" placeholder="輸入新狀態名稱"><button class="btn btn-primary"
                            onclick="addNewStatusType()">新增</button></div>
                    <hr>
                    <h6>目前可用狀態:</h6>
                    <div id="statusListContainer" class="d-flex flex-wrap"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="batchAddModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量新增學生</h5><button type="button" class="btn-close"
                        data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small">格式：<strong>班級 組別 姓名</strong> (中間空白)<br>範例：<br>101 A組 王小明
                    </div>
                    <textarea id="batchInput" class="form-control" rows="10" placeholder="101 A組 王小明"></textarea>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">取消</button><button type="button" class="btn btn-primary"
                        onclick="batchAddStudents()">開始匯入</button></div>
            </div>
        </div>
    </div>

    <!-- Login Modal (For Students) -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="loginModalTitle">登入</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="loginTargetName" class="fw-bold text-center fs-5 mb-3"></p>
                    <input type="password" id="loginPassword" class="form-control text-center mb-3"
                        placeholder="請輸入密碼 (預設0000)">
                    <p id="loginError" class="text-danger small text-center mb-0"></p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-primary w-100" onclick="performLogin()">登入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div class="modal fade" id="adminLoginModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="bi bi-shield-lock-fill me-2"></i>管理員登入</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" id="adminUsername" class="form-control" placeholder="帳號">
                    </div>
                    <div class="mb-3">
                        <input type="password" id="adminPassword" class="form-control" placeholder="密碼">
                    </div>
                    <p id="adminLoginError" class="text-danger small text-center mb-0"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-dark w-100" onclick="performAdminLogin()">登入</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">修改密碼</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">舊密碼</label>
                        <input type="password" id="oldPass" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">新密碼</label>
                        <input type="password" id="newPass" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">確認新密碼</label>
                        <input type="password" id="confirmPass" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitChangePassword()">確認修改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Modal -->
    <div class="modal fade" id="adminDashboardModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title"><i class="bi bi-shield-lock-fill me-2"></i>人員權限管理</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="adminUserSearch" class="form-control" placeholder="搜尋姓名、班級或權限..."
                            oninput="renderAdminUserList()">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>姓名</th>
                                    <th>班級 / 組別</th>
                                    <th>權限角色</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="adminUserListBody">
                                <!-- JS Generated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div class="modal fade" id="approvalModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold"><i class="bi bi-clipboard-check me-2"></i>審核申請</h5>
                    <div class="ms-auto me-2">
                        <button class="btn btn-success btn-sm me-1"
                            onclick="batchHandleRequests('approve')">全部批准</button>
                        <button class="btn btn-danger btn-sm" onclick="batchHandleRequests('reject')">全部駁回</button>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="approvalList" class="list-group list-group-flush">
                        <!-- JS Generated Requests -->
                        <div class="text-center p-4 text-muted">目前沒有待審核的申請</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyACL_67nXJU6RZEf3InFqHQJ-5h6FMZ7t8",
            authDomain: "check-74ee8.firebaseapp.com",
            projectId: "check-74ee8",
            storageBucket: "check-74ee8.firebasestorage.app",
            messagingSenderId: "795590503656",
            appId: "1:795590503656:web:f68019efd5eb88aa51ed5d",
            measurementId: "G-QMBN11NQ34"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const studentsRef = collection(db, "students");
        const requestsRef = collection(db, "requests"); // New collection for approval requests
        const configRef = doc(db, "settings", "globalConfig");

        const sessions = ["早點名", "早上上餐廳", "0740集合", "中午上餐廳", "1320集合", "晚上上餐廳", "晚自習", "晚點名", "備用點名"];
        const days = ["星期一", "星期二", "星期三", "星期四", "星期五", "星期六", "星期日"];

        let currentSession = sessions[0];
        let currentDay = days[0];
        let currentGroupMode = "class";
        let currentStatuses = ["實到", "遲到", "缺席"];

        let studentsData = [];
        let pendingRequests = []; // Store active requests

        let currentUser = null; // { id, name, role, class, group }
        // Check session storage
        try {
            const storedUser = sessionStorage.getItem('currentUser');
            if (storedUser) {
                currentUser = JSON.parse(storedUser);
            }
        } catch (e) {
            console.error("Session load error", e);
        }

        // 初始化
        initWeekTabs();
        initSessionTabs();

        // 功能: 複製
        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => alert("已複製到剪貼簿！"))
                    .catch(err => fallbackCopyTextToClipboard(text));
            } else {
                fallbackCopyTextToClipboard(text);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                var successful = document.execCommand('copy');
                var msg = successful ? '已複製到剪貼簿！' : '複製失敗';
                alert(msg);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                alert("複製失敗 (瀏覽器不支援)");
            }
            document.body.removeChild(textArea);
        }

        function getStatusKey(session) {
            return `${currentDay}_${session}`;
        }

        function generateReportText(scope, groupName = null, specifiedSession = null) {
            let output = "";
            const targetSessions = specifiedSession ? [specifiedSession] : sessions;

            if (scope === 'all') {
                targetSessions.forEach(session => {
                    const statusKey = getStatusKey(session);
                    const stats = { '實到': 0 };
                    const detailList = {};
                    currentStatuses.forEach(s => { if (s !== '實到') detailList[s] = []; });
                    let total = 0;

                    studentsData.forEach(s => {
                        total++;
                        const status = (s.status && s.status[statusKey]) ? s.status[statusKey] : '實到';
                        if (status === '實到') stats['實到']++;
                        else {
                            if (!detailList[status]) detailList[status] = [];
                            detailList[status].push(s.name);
                        }
                    });

                    output += `應到:${total}\n`;
                    output += `事故：\n`;
                    Object.entries(detailList).forEach(([status, names]) => {
                        if (names.length > 0) {
                            output += `${status}${names.length} ${names.join(' ')}\n`;
                        }
                    });
                    output += `實到：${stats['實到']}\n\n`;
                });
                return output;
            }

            let targetGroups = [groupName];
            targetGroups.forEach(gName => {
                output += `${gName}\n\n`;
                targetSessions.forEach(session => {
                    const groupStudents = studentsData.filter(s => {
                        const sGroup = currentGroupMode === 'class' ? s.class : (s.group || '未分組');
                        return sGroup === gName;
                    });
                    if (groupStudents.length === 0) return;
                    const total = groupStudents.length;
                    const statusKey = getStatusKey(session);
                    const stats = { '實到': 0 };
                    const detailList = {};
                    currentStatuses.forEach(s => { if (s !== '實到') detailList[s] = []; });

                    groupStudents.forEach(s => {
                        const status = (s.status && s.status[statusKey]) ? s.status[statusKey] : '實到';
                        if (status === '實到') stats['實到']++;
                        else {
                            if (!detailList[status]) detailList[status] = [];
                            detailList[status].push(s.name);
                        }
                    });

                    output += `${session}\n應到${total}\n事故：\n`;
                    Object.entries(detailList).forEach(([status, names]) => {
                        if (names.length > 0) output += `${status}${names.length} ${names.join(' ')}\n`;
                    });
                    output += `實到：${stats['實到']}\n\n`;
                });
                output += `------------------\n\n`;
            });
            return output;
        }

        onSnapshot(configRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                if (data.statuses && Array.isArray(data.statuses)) {
                    currentStatuses = data.statuses;
                    renderStatusSettings();
                    renderAll();
                }
            } else {
                setDoc(configRef, { statuses: ["實到", "遲到", "缺席", "病假", "事假", "公假"] });
            }
        });

        const q = query(studentsRef);
        const unsubscribeStudents = onSnapshot(q, (snapshot) => {
            studentsData = [];
            snapshot.forEach((doc) => studentsData.push({ id: doc.id, ...doc.data() }));
            studentsData.sort((a, b) => {
                if (a.class !== b.class) return a.class.localeCompare(b.class);
                return (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0);
            });
            try { renderAll(); } catch (err) { console.error(err); }
        });

        const requestsQ = query(requestsRef);
        const unsubscribeRequests = onSnapshot(requestsQ, (snapshot) => {
            pendingRequests = [];
            snapshot.forEach((doc) => {
                pendingRequests.push({ id: doc.id, ...doc.data() });
            });
            renderAll(); // Re-render when requests change
            if (typeof updateNotificationBadge === 'function') updateNotificationBadge(); // Helper: Force badge update
            if (typeof refreshApprovalModal === 'function') refreshApprovalModal(); // Refresh modal content if open
        });

        function initWeekTabs() {
            const container = document.getElementById('weekTabs');
            container.innerHTML = days.map(d => `
                <button class="btn ${currentDay === d ? 'btn-primary' : 'btn-outline-secondary'} rounded-pill text-nowrap px-4" 
                        onclick="changeDay('${d}')">${d}</button>
            `).join('');
        }

        function initSessionTabs() {
            const container = document.getElementById('sessionTabs');
            container.innerHTML = sessions.map(s => `
                <button class="btn ${currentSession === s ? 'btn-primary' : 'btn-white bg-white border'} rounded-pill text-nowrap px-3 shadow-sm" 
                        onclick="changeSession('${s}')">${currentDay} - ${s}</button>
            `).join('');
        }

        window.changeDay = (d) => {
            currentDay = d;
            initWeekTabs();
            initSessionTabs();
            renderAll();
        };

        window.changeSession = (s) => {
            currentSession = s;
            initSessionTabs();
            renderAll();
        };

        function renderAll() {
            if (currentUser && typeof updateNotificationBadge === 'function') {
                try { updateNotificationBadge(); } catch (e) { }
            }

            const container = document.getElementById('classContainer');
            const globalStatsPanel = document.getElementById('globalStatsPanel');
            document.getElementById('currentSessionLabel').innerText = `(${currentDay} - ${currentSession})`;
            container.innerHTML = ""; globalStatsPanel.innerHTML = "";

            const grouped = {};
            const globalStats = { total: 0, byStatus: {}, byStatusNames: {} };
            currentStatuses.forEach(s => {
                globalStats.byStatus[s] = 0;
                globalStats.byStatusNames[s] = [];
            });

            studentsData.forEach(student => {
                let key = currentGroupMode === 'class' ? student.class : student.group;
                if (!key) key = "未分組";
                if (!grouped[key]) {
                    // Initialize group stats with names array
                    grouped[key] = { students: [], stats: { total: 0, byStatus: {}, byStatusNames: {} } };
                    currentStatuses.forEach(s => {
                        grouped[key].stats.byStatus[s] = 0;
                        grouped[key].stats.byStatusNames[s] = [];
                    });
                }
                grouped[key].students.push(student);

                // Use Composite Key
                const statusKey = getStatusKey(currentSession);
                let status = "實到";
                if (student.status && student.status[statusKey]) status = student.status[statusKey];
                student._currentStatus = status;

                grouped[key].stats.total++;
                if (grouped[key].stats.byStatus[status] !== undefined) {
                    grouped[key].stats.byStatus[status]++;
                    grouped[key].stats.byStatusNames[status].push(student.name);
                }

                globalStats.total++;
                if (globalStats.byStatus[status] !== undefined) {
                    globalStats.byStatus[status]++;
                    globalStats.byStatusNames[status].push(student.name);
                }
            });

            // Global Stats
            let globalStatsHtml = `
                <div class="d-flex align-items-center me-4 mb-2">
                    <span class="text-muted small me-2">應到</span>
                    <span class="fs-4 fw-bold text-dark">${globalStats.total}</span>
                </div>
                <div class="d-flex align-items-center me-4 mb-2">
                    <span class="text-muted small me-2">實到</span>
                    <span class="fs-4 fw-bold text-success">${globalStats.byStatus['實到'] || 0}</span>
                </div>
            `;

            let breakdownHtml = "";
            Object.entries(globalStats.byStatusNames).forEach(([status, names]) => {
                if (status !== '實到' && names.length > 0) {
                    breakdownHtml += `
                        <div class="mb-1">
                            <span class="badge bg-light text-danger border border-danger me-1">${status} (${names.length})</span>
                            <span class="small text-secondary">${names.join(', ')}</span>
                        </div>
                    `;
                }
            });

            if (breakdownHtml) {
                globalStatsHtml += `<div class="d-flex flex-column border-start ps-3 ms-2">${breakdownHtml}</div>`;
            } else {
                globalStatsHtml += `<div class="d-flex flex-column border-start ps-3 ms-2"><span class="text-muted small">全員實到</span></div>`;
            }

            globalStatsPanel.innerHTML = globalStatsHtml;

            if (Object.keys(grouped).length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted py-5">目前沒有資料，請從上方新增。</div>`;
                return;
            }

            Object.keys(grouped).sort().forEach(groupName => {
                const group = grouped[groupName];
                let classStatStr = `應到: ${group.stats.total} | 實到: ${group.stats.byStatus['實到'] || 0}`;

                // Generate class detail string
                let classDetailHtml = "";
                Object.entries(group.stats.byStatusNames).forEach(([status, names]) => {
                    if (status !== '實到' && names.length > 0) {
                        classDetailHtml += `<div class="text-end" style="font-size: 0.85rem;">${status}: ${names.length} (${names.join(' ')})</div>`;
                    }
                });

                const rows = group.students.map(student => {
                    // Determine Permissions
                    let canEdit = false;
                    let canDelete = false;

                    if (currentUser) {
                        if (currentUser.role === 'super_admin') {
                            canEdit = true;
                            canDelete = true;
                        } else if (currentUser.role === 'general_admin') {
                            canEdit = true;
                            canDelete = true;
                        } else if (currentUser.role === 'class_admin') {
                            if (currentUser.class === student.class) {
                                canEdit = true;
                                canDelete = false; // Restricted
                            }
                        } else if (currentUser.role === 'group_admin') {
                            // Dining sessions: edit group members. Other times: only self
                            const isDining = (currentSession === '中午上餐廳' || currentSession === '晚上上餐廳');
                            if (isDining && student.group === currentUser.group) {
                                canEdit = true;
                            } else if (currentUser.id === student.id) {
                                canEdit = true;
                            }
                        } else { // student
                            if (currentUser.id === student.id) canEdit = true;
                        }
                    }

                    // Check for Pending Requests
                    const sessionKey = `${currentDay}_${currentSession}`;

                    const pendingReq = pendingRequests.find(r =>
                        r.studentId === student.id &&
                        r.targetSession === sessionKey &&
                        r.status === 'pending'
                    );

                    let statusDisplay = getStatusBadge(student._currentStatus);
                    let rowStyle = "";

                    if (pendingReq) {
                        statusDisplay = `<span class="badge bg-warning text-dark">審核中: ${pendingReq.newStatus}</span>`;
                        canEdit = false; // Lock editing while pending
                        rowStyle = "background-color: #fff3cd;"; // Light yellow row
                    }

                    // Onclick name: if not logged in, trigger login. If logged in but no edit, do nothing or show info.
                    const nameAction = !currentUser ? `onclick="initLogin('${student.id}', '${student.name}')" style="cursor: pointer; text-decoration: underline;"` : '';

                    return `
                    <tr style="${rowStyle}">
                        <td>
                            <span class="fw-bold ${getNameColorClass(student._currentStatus)}" ${nameAction}>${student.name}</span>
                            <br><span class="badge bg-light text-secondary border">${student.class} / ${student.group || '-'}</span>
                        </td>
                        <td>${statusDisplay}</td>
                        <td>
                            <select class="form-select form-select-sm fw-bold ${getStatusColorClass(student._currentStatus)}" 
                                    onchange="updateStatus('${student.id}', this.value)" 
                                    style="min-width: 110px;"
                                    ${canEdit ? '' : 'disabled'}>
                                ${currentStatuses.map(s => `<option value="${s}" ${student._currentStatus === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </td>
                         <td class="text-end">
                            ${(pendingReq && currentUser && (currentUser.id === pendingReq.requesterId || currentUser.role === 'super_admin')) ?
                            `<button class="btn btn-sm btn-outline-danger" onclick="cancelRequest('${pendingReq.id}')" title="取消申請"><i class="bi bi-x-lg"></i></button>` :
                            (canDelete ? `<button class="btn btn-sm btn-light text-danger" onclick="removeStudent('${student.id}')"><i class="bi bi-trash"></i></button>` : '')
                        }
                        </td>
                    </tr>
                `}).join('');

                const card = `
                    <div class="col-xl-6 col-12">
                        <div class="card shadow-sm border-0 h-100">
                            <div class="class-header d-flex justify-content-between align-items-start">
                                <div class="d-flex align-items-center mt-1">
                                    <span class="fs-5 me-2"><i class="bi bi-house-door-fill me-2"></i>${groupName}</span>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-link text-white p-0" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="copyToClipboard(generateReportText('group', '${groupName}', '${currentSession}'))">複製本班 (當下時段)</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="copyToClipboard(generateReportText('group', '${groupName}', null))">複製本班 (全部時段)</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-warning" href="#" onclick="resetStatus('current', '${groupName}')">重置本時段 (全實到)</a></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="resetStatus('day', '${groupName}')">重置整天 (全實到)</a></li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="d-flex flex-column align-items-end">
                                    <span class="badge bg-light text-dark opacity-75 fw-normal fs-6 mb-1">${classStatStr}</span>
                                    <div class="text-white opacity-90">${classDetailHtml}</div>
                                </div>
                            </div>
                            <div class="card-body p-0"><div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="table-light"><tr><th style="width: 25%">姓名</th><th style="width: 15%">狀態</th><th>操作</th><th style="width: 10%"></th></tr></thead><tbody>${rows}</tbody></table></div></div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });

            // Re-apply search filter if exists
            if (document.getElementById('searchInput').value.trim()) {
                filterStudents();
            }
        }

        window.migrateData = async () => {
            if (!confirm('確定要執行資料遷移？這將為所有學生設定預設密碼 0000 與角色 student。')) return;
            console.log("開始遷移資料...");
            const snapshot = await getDocs(studentsRef);
            let updateCount = 0;
            const promises = [];

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                // Check if migration is needed
                if (!data.password || !data.role) {
                    promises.push(updateDoc(doc(db, "students", docSnap.id), {
                        password: data.password || '0000',
                        role: data.role || 'student'
                    }));
                    updateCount++;
                }
            });

            try {
                await Promise.all(promises);
                console.log(`遷移完成！共更新 ${updateCount} 筆資料。`);
                alert(`遷移完成！共更新 ${updateCount} 筆資料。`);
            } catch (e) {
                console.error("遷移失敗", e);
                alert("遷移失敗，請查看 Console。");
            }
        };
        window.changeSession = (n) => { currentSession = n; initSessionTabs(); renderAll(); };
        window.setGroupBy = (m) => { currentGroupMode = m; renderAll(); };
        window.addStudent = async () => {
            if (!currentUser || (currentUser.role !== 'super_admin' && currentUser.role !== 'general_admin')) return alert("權限不足");
            const classInput = document.getElementById('inputClass').value.trim();
            const groupInput = document.getElementById('inputGroup').value.trim();
            const nameInput = document.getElementById('inputName').value.trim();
            if (!classInput || !nameInput) return alert("請輸入班級和姓名");
            try {
                await addDoc(studentsRef, {
                    class: classInput,
                    group: groupInput || "無",
                    name: nameInput,
                    status: {},
                    password: '0000',
                    role: 'student',
                    timestamp: new Date()
                });
                document.getElementById('inputName').value = '';
            } catch (e) { console.error(e); alert("新增失敗"); }
        };
        window.batchAddStudents = async () => {
            if (!currentUser || (currentUser.role !== 'super_admin' && currentUser.role !== 'general_admin')) return alert("權限不足");
            const input = document.getElementById('batchInput').value.trim();
            if (!input) return;
            const lines = input.split('\n');
            const promises = [];
            for (let line of lines) {
                line = line.trim();
                const parts = line.split(/\s+/);
                if (parts.length < 3) continue;
                promises.push(addDoc(studentsRef, {
                    class: parts[0],
                    group: parts[1],
                    name: parts.slice(2).join(' '),
                    status: {},
                    password: '0000',
                    role: 'student',
                    timestamp: new Date()
                }));
            }
            try {
                await Promise.all(promises);
                alert("匯入成功！");
                bootstrap.Modal.getOrCreateInstance(document.getElementById('batchAddModal')).hide();
                document.getElementById('batchInput').value = '';
            } catch (e) { console.error(e); alert("匯入失敗"); }
        };
        window.updateStatus = async (id, val) => {
            if (!currentUser) return;

            const student = studentsData.find(s => s.id === id);
            if (!student) return;

            let canDirectlyUpdate = false;

            if (currentUser.role === 'super_admin') {
                canDirectlyUpdate = true;
            } else if (currentUser.role === 'general_admin') {
                canDirectlyUpdate = true;
            } else if (currentUser.role === 'class_admin') {
                if (currentUser.class === student.class) canDirectlyUpdate = true;
            } else if (currentUser.role === 'group_admin') {
                // Dining sessions: edit group members. Other times: only self (but self needs request?)
                // Plan: "Other times only can request for themselves". So Group Admin for others in non-dining = No.
                // Group Admin for self in non-dining = Request (based on "Students submit requests").

                const isDining = (currentSession === '中午上餐廳' || currentSession === '晚上上餐廳');
                if (isDining && student.group === currentUser.group) {
                    canDirectlyUpdate = true;
                }
                // Note: Self-update for students/admins outside their scope defaults to Request.
            }

            const statusKey = getStatusKey(currentSession);

            if (canDirectlyUpdate) {
                try {
                    const studentRef = doc(db, "students", id);
                    await updateDoc(studentRef, { [`status.${statusKey}`]: val });
                } catch (e) {
                    console.error("Error updating status: ", e);
                    alert("更新失敗: " + e.message);
                }
            } else {
                // Create Request
                try {
                    await addDoc(requestsRef, {
                        studentId: id,
                        studentName: student.name,
                        studentClass: student.class,
                        studentGroup: student.group || '',
                        targetSession: statusKey, // e.g. 星期一_早點名
                        sessionName: currentSession,
                        dayName: currentDay,
                        originStatus: (student.status && student.status[statusKey]) ? student.status[statusKey] : '實到',
                        newStatus: val,
                        requesterId: currentUser.id,
                        requesterName: currentUser.name,
                        timestamp: new Date().toISOString(),
                        status: 'pending' // pending, approved, rejected
                    });
                    alert("已送出狀態變更申請，請等待幹部審核。");
                    // Reset select to original value visually (will be handled by re-render, but good specifically)
                    renderAll();
                } catch (e) {
                    console.error("Error sending request: ", e);
                    alert("送出申請失敗: " + e.message);
                }
            }
        };
        window.removeStudent = async (id) => {
            if (!currentUser || (currentUser.role !== 'super_admin' && currentUser.role !== 'general_admin')) return alert("權限不足");
            if (confirm('確定刪除？')) await deleteDoc(doc(db, "students", id));
        };
        window.addNewStatusType = async () => {
            if (!currentUser || !['super_admin', 'general_admin', 'class_admin', 'group_admin'].includes(currentUser.role)) return alert("權限不足");
            const val = document.getElementById('newStatusInput').value.trim();
            if (!val || currentStatuses.includes(val)) return;
            await updateDoc(configRef, { statuses: [...currentStatuses, val] });
            document.getElementById('newStatusInput').value = '';
        };
        window.removeStatusType = async (val) => {
            if (!currentUser || !['super_admin', 'general_admin', 'class_admin', 'group_admin'].includes(currentUser.role)) return alert("權限不足");
            if (confirm(`移除 ${val}?`)) await updateDoc(configRef, { statuses: currentStatuses.filter(s => s !== val) });
        };

        window.resetStatus = async (scope, groupName) => {
            if (!currentUser) return alert("請先登入");

            // Permission Check
            let canReset = false;
            if (currentUser.role === 'super_admin' || currentUser.role === 'general_admin') canReset = true;
            if (currentUser.role === 'class_admin' && currentUser.class === groupName) {
                const isDining = (currentSession === '中午上餐廳' || currentSession === '晚上上餐廳');
                if (scope === 'day') {
                    // Class Admin cannot reset 'day' because it includes dining sessions which they don't manage
                    canReset = false;
                } else {
                    // Scope is current. Allow only if NOT dining.
                    canReset = !isDining;
                }
            }
            if (currentUser.role === 'group_admin' && currentUser.group === groupName) {
                // Group admin logic: usually restricted to dining, but for "Reset" let's allow if it's their group?
                // User asked for "Reset" on the 3 dots.
                // Let's stick to the rule: Group Admin only valid for Dining Sessions?
                // Or maybe just let them manage their group if they see the button.
                // However, "Reset All Day" might be too powerful if they only manage dining.
                // Let's restrict based on session for safety?
                // The prompt didn't specify, but safer to follow general rules.
                // Actually, "Reset All Day" implies modifying non-dining sessions.
                // If Group Admin is restricted to Dining, they shouldn't reset "Morning Call".
                // So "Reset All Day" should be BLOCKED for Group Admin if they are dining only.
                // Let's allow simple logic for now: If they can edit the group, they can reset.
                // But wait, group_admin logic in updateStatus was strict.
                // Let's check updateStatus logic:
                // Group Admin can edit IF isDining AND student.group == currentUser.group.
                // So if scope is 'day', it touches non-dining. Thus Group Admin cannot 'day'.
                if (scope === 'day') canReset = false;
                else {
                    // scope is 'current'. Is it dining?
                    const isDining = (currentSession === '中午上餐廳' || currentSession === '晚上上餐廳');
                    if (isDining) canReset = true;
                }
            }

            if (!canReset) return alert("權限不足");

            const label = scope === 'current' ? `本時段 (${currentSession})` : `今天 (${currentDay})`;
            if (!confirm(`確定要將 ${groupName} 的 ${label} 所有差勤狀態重置為「實到」嗎？此操作無法復原。`)) return;

            // Find target students
            const targets = studentsData.filter(s => {
                if (currentGroupMode === 'class') return s.class === groupName;
                if (currentGroupMode === 'group') return s.group === groupName;
                return false;
            });

            if (targets.length === 0) return alert("找不到學生資料");

            let updateCount = 0;
            const promises = [];

            for (const s of targets) {
                const updates = {};
                if (scope === 'current') {
                    const key = `${currentDay}_${currentSession}`;
                    updates[`status.${key}`] = '實到';
                } else {
                    // All sessions for today
                    sessions.forEach(sess => {
                        const key = `${currentDay}_${sess}`;
                        updates[`status.${key}`] = '實到';
                    });
                }
                promises.push(updateDoc(doc(db, "students", s.id), updates));
                updateCount++;
            }

            try {
                await Promise.all(promises);
                alert(`已重置 ${updateCount} 位學生的狀態。`);
                renderAll(); // Should trigger automatically by snapshot but good to force
            } catch (e) {
                console.error(e);
                alert("重置失敗: " + e.message);
            }
        };
        // Export locally defined functions to global scope
        window.copyToClipboard = copyToClipboard;
        window.generateReportText = generateReportText;
        window.filterStudents = filterStudents;
        window.copyGlobalReport = () => copyToClipboard(generateReportText('all', null, currentSession));

        // --- Auth & Login Logic ---

        // Update UI based on login status
        function updateAuthUI() {
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            const userInfoDisplay = document.getElementById('userInfoDisplay');
            const userNameDisplay = document.getElementById('userNameDisplay');
            const notificationBtn = document.getElementById('notificationBtn');
            const adminManageLink = document.getElementById('adminManageLink');

            if (currentUser) {
                adminLoginBtn.classList.add('d-none');
                userInfoDisplay.classList.remove('d-none');
                userInfoDisplay.classList.add('d-flex');

                let roleName = "學生";
                let isAdmin = false;

                if (currentUser.role === 'super_admin') { roleName = "超級管理員"; isAdmin = true; }
                else if (currentUser.role === 'general_admin') { roleName = "管理員"; isAdmin = true; }
                else if (currentUser.role === 'class_admin') { roleName = "實習幹部"; isAdmin = true; }
                else if (currentUser.role === 'group_admin') { roleName = "組別班代"; isAdmin = true; }

                userNameDisplay.innerHTML = `${currentUser.name} <span class="badge bg-secondary ms-1" style="font-size: 0.7em;">${roleName}</span>`;

                if (isAdmin) {
                    notificationBtn.classList.remove('d-none');
                    updateNotificationBadge();
                } else {
                    notificationBtn.classList.add('d-none');
                }

                if (currentUser.role === 'super_admin') {
                    adminManageLink.classList.remove('d-none');
                } else {
                    adminManageLink.classList.add('d-none');
                }

                // Control Add Student Button visibility
                const addStudentBtn = document.getElementById('addStudentBtn');
                if (currentUser.role === 'super_admin' || currentUser.role === 'general_admin') {
                    addStudentBtn.classList.remove('d-none');
                } else {
                    addStudentBtn.classList.add('d-none');
                }

            } else {
                adminLoginBtn.classList.remove('d-none');
                userInfoDisplay.classList.add('d-none');
                userInfoDisplay.classList.remove('d-flex');
                notificationBtn.classList.add('d-none');
                adminManageLink.classList.add('d-none');

                // Hide Add btn if not logged in (or show if you want default to be visible? No, default should be hidden or visible? 
                // Original behavior: it was visible. 
                // Requirement: "Student Cadre cannot add". 
                // If not logged in, who are they? Guest. Should Guest add? Probably not.
                // Let's hide it for consistency.
                const addStudentBtn = document.getElementById('addStudentBtn');
                if (addStudentBtn) addStudentBtn.classList.add('d-none');
            }
            renderAll(); // Re-render to update permissions
            renderStatusSettings(); // Re-render settings modal UI based on new permissions
        }

        window.showAdminDashboard = () => {
            renderAdminUserList();
            bootstrap.Modal.getOrCreateInstance(document.getElementById('adminDashboardModal')).show();
        };

        window.showAddStudentModal = () => {
            bootstrap.Modal.getOrCreateInstance(document.getElementById('addStudentModal')).show();
        };

        window.renderAdminUserList = () => {
            const tbody = document.getElementById('adminUserListBody');
            const term = document.getElementById('adminUserSearch').value.toLowerCase();

            const filtered = studentsData.filter(s =>
                s.name.includes(term) ||
                s.class.includes(term) ||
                (s.role || 'student').includes(term)
            );

            const roleOptions = [
                { val: 'student', label: '學生' },
                { val: 'group_admin', label: '組別班代' },
                { val: 'class_admin', label: '實習幹部' },
                { val: 'general_admin', label: '管理員' }
            ];

            tbody.innerHTML = filtered.map(s => {
                const currentRole = s.role || 'student';
                return `
                    <tr>
                        <td>${s.name}</td>
                        <td>${s.class} <small class="text-muted">(${s.group || '-'})</small></td>
                        <td>
                            <select class="form-select form-select-sm" onchange="updateUserRole('${s.id}', this.value)">
                                ${roleOptions.map(opt => `<option value="${opt.val}" ${currentRole === opt.val ? 'selected' : ''}>${opt.label}</option>`).join('')}
                            </select>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary" onclick="resetUserPassword('${s.id}', '${s.name}')">重置密碼</button>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        window.updateUserRole = async (uid, newRole) => {
            if (currentUser.role !== 'super_admin') {
                alert("您沒有權限執行此操作。");
                return;
            }
            try {
                await updateDoc(doc(db, "students", uid), { role: newRole });
                // alert("權限已更新");
                studentsData.find(s => s.id === uid).role = newRole; // Optimistic update
            } catch (e) {
                console.error(e);
                alert("更新失敗: " + e.message);
            }
        };

        window.resetUserPassword = async (uid, name) => {
            if (!confirm(`確定要將 ${name} 的密碼重置為 0000 嗎？`)) return;
            try {
                await updateDoc(doc(db, "students", uid), { password: '0000' });
                alert("密碼已重置為 0000");
            } catch (e) {
                console.error(e);
                alert("重置失敗: " + e.message);
            }
        };

        function getRelevantRequests() {
            if (!currentUser) return [];
            return pendingRequests.filter(req => {
                if (req.status !== 'pending') return false;

                if (currentUser.role === 'super_admin' || currentUser.role === 'general_admin') return true;
                if (currentUser.role === 'class_admin') {
                    return req.studentClass === currentUser.class;
                }
                if (currentUser.role === 'group_admin') {
                    // Only dining sessions for Group Admin? Or all? 
                    // Plan: "Group Admin approval rights restricted to dining sessions."
                    // Let's implement that strict check.
                    // Wait, req contains `targetSession` (key) and `sessionName`.
                    // Check if sessionName contains "餐廳" ?
                    const isDining = (req.sessionName === '中午上餐廳' || req.sessionName === '晚上上餐廳');
                    if (isDining && req.studentGroup === currentUser.group) return true;
                    // Else: Cannot approve. 
                }
                return false;
            });
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const relevant = getRelevantRequests();
            const count = relevant.length;

            if (count > 0) {
                badge.innerText = count;
                badge.classList.remove('d-none');
            } else {
                badge.classList.add('d-none');
            }
        }

        // Hook updateNotificationBadge into renderAll/snapshot
        // Actually better to hook where pendingRequests updates.
        // I'll add a call to updateNotificationBadge inside the requests snapshot listener in the next step or manually add it here if I can find the listener.
        // But wait, `renderAll` is called by the listener. So I can just add `updateNotificationBadge()` inside `renderAll`? 
        // Yes, let's add it to `renderAll` or `updateAuthUI`. 
        // Since `renderAll` is called frequently, let's put it there. 
        // However, `renderAll` doesn't have access to this scope easily if strictly separated? 
        // They are all in module scope. It's fine.

        window.showApprovalModal = () => {
            const list = document.getElementById('approvalList');
            const relevant = getRelevantRequests();

            if (relevant.length === 0) {
                list.innerHTML = `<div class="text-center p-4 text-muted">目前沒有待審核的申請</div>`;
            } else {
                list.innerHTML = relevant.map(req => `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="d-flex align-items-center mb-1">
                                <span class="fw-bold me-2">${req.studentName}</span>
                                <span class="badge bg-light text-secondary border me-2">${req.studentClass}/${req.studentGroup}</span>
                                <span class="badge bg-warning text-dark">${req.dayName || ''} ${req.sessionName}</span>
                            </div>
                            <div class="small">
                                <span class="text-muted">由 ${req.requesterName} 申請：</span>
                                <span class="text-decoration-line-through text-muted mx-1">${req.originStatus}</span>
                                <i class="bi bi-arrow-right mx-1"></i>
                                <span class="fw-bold text-danger">${req.newStatus}</span>
                            </div>
                            <div class="text-muted" style="font-size: 0.75rem;">${new Date(req.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-success btn-sm me-2" onclick="handleRequest('${req.id}', 'approve')">
                                <i class="bi bi-check-lg"></i> 批准
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="handleRequest('${req.id}', 'reject')">
                                <i class="bi bi-x-lg"></i> 駁回
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            bootstrap.Modal.getOrCreateInstance(document.getElementById('approvalModal')).show();
        };

        window.batchHandleRequests = async (action) => {
            const relevant = getRelevantRequests();
            if (relevant.length === 0) return alert("目前沒有可處理的申請");

            if (!confirm(`確定要全部 ${action === 'approve' ? '批准' : '駁回'} 共 ${relevant.length} 筆申請嗎？`)) return;

            try {
                let count = 0;
                for (const req of relevant) {
                    if (action === 'approve') {
                        const studentRef = doc(db, "students", req.studentId);
                        await updateDoc(studentRef, { [`status.${req.targetSession}`]: req.newStatus });
                    }
                    await deleteDoc(doc(db, "requests", req.id));
                    count++;
                }
            } catch (e) {
                console.error(e);
                alert("批量操作部分失敗: " + e.message);
            }
        };

        window.handleRequest = async (reqId, action) => {
            const req = pendingRequests.find(r => r.id === reqId);
            if (!req) return;

            if (!confirm(`確定要 ${action === 'approve' ? '批准' : '駁回'} ${req.studentName} 的申請嗎？`)) return;

            try {
                if (action === 'approve') {
                    // 1. Update Student Data
                    const studentRef = doc(db, "students", req.studentId);
                    await updateDoc(studentRef, { [`status.${req.targetSession}`]: req.newStatus });

                    // 2. Delete Request (or update to approved)
                    await deleteDoc(doc(db, "requests", reqId));
                    // alert("已批准"); // Optional, maybe too noisy
                } else {
                    // Reject: Just delete request
                    await deleteDoc(doc(db, "requests", reqId));
                }
                // Modal will refresh automatically next time opened or via listener?
                // Snapshot will trigger update of pendingRequests.
                // We should re-render modal if it's open.
                // Ideally the snapshot listener calls renderAll.
                // We can check if modal is open and refresh it.
                // Let's add a global listener for that.
                // bootstrap.Modal.getOrCreateInstance(document.getElementById('approvalModal')).hide();
                // Do not hide. The list will refresh via the snapshot listener -> renderAll -> refreshModal invocation.
            } catch (e) {
                console.error(e);
                alert("操作失敗: " + e.message);
            }
        };

        // Helper to refresh modal list if open
        function refreshApprovalModal() {
            const modalEl = document.getElementById('approvalModal');
            if (modalEl && modalEl.classList.contains('show')) {
                // Re-use logic from showApprovalModal but only update list
                const list = document.getElementById('approvalList');
                const relevant = getRelevantRequests();
                if (relevant.length === 0) {
                    list.innerHTML = `<div class="text-center p-4 text-muted">目前沒有待審核的申請</div>`;
                } else {
                    list.innerHTML = relevant.map(req => `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <div class="d-flex align-items-center mb-1">
                                <span class="fw-bold me-2">${req.studentName}</span>
                                <span class="badge bg-light text-secondary border me-2">${req.studentClass}/${req.studentGroup}</span>
                                <span class="badge bg-warning text-dark">${req.dayName || ''} ${req.sessionName}</span>
                            </div>
                            <div class="small">
                                <span class="text-muted">由 ${req.requesterName} 申請：</span>
                                <span class="text-decoration-line-through text-muted mx-1">${req.originStatus}</span>
                                <i class="bi bi-arrow-right mx-1"></i>
                                <span class="fw-bold text-danger">${req.newStatus}</span>
                            </div>
                            <div class="text-muted" style="font-size: 0.75rem;">${new Date(req.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-success btn-sm me-2" onclick="handleRequest('${req.id}', 'approve')">
                                <i class="bi bi-check-lg"></i> 批准
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="handleRequest('${req.id}', 'reject')">
                                <i class="bi bi-x-lg"></i> 駁回
                            </button>
                        </div>
                    </div>
                `).join('');
                }
            }
        }

        window.cancelRequest = async (reqId) => {
            if (!confirm("確定要取消此變更申請嗎？")) return;
            try {
                await deleteDoc(doc(db, "requests", reqId));
                // UI updates via snapshot
            } catch (e) {
                console.error(e);
                alert("取消失敗: " + e.message);
            }
        };

        window.initLogin = (studentId, studentName) => {
            if (currentUser) return; // Already logged in
            document.getElementById('loginTargetName').innerText = `登入：${studentName}`;
            document.getElementById('loginTargetName').dataset.id = studentId; // Restore missing ID setting
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').innerText = '';
            bootstrap.Modal.getOrCreateInstance(document.getElementById('loginModal')).show();
        };

        window.performLogin = async () => {
            const studentId = document.getElementById('loginTargetName').dataset.id;
            const password = document.getElementById('loginPassword').value;
            // Find student data
            const student = studentsData.find(s => s.id === studentId);
            if (!student) return;

            if (student.password === password) {
                currentUser = {
                    id: student.id,
                    name: student.name,
                    role: student.role || 'student',
                    class: student.class,
                    group: student.group
                };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                bootstrap.Modal.getOrCreateInstance(document.getElementById('loginModal')).hide();
                updateAuthUI();
                // Check if password is default
                if (password === '0000') {
                    setTimeout(() => {
                        if (confirm("您目前使用預設密碼，建議立即修改。是否前往修改？")) {
                            bootstrap.Modal.getOrCreateInstance(document.getElementById('changePasswordModal')).show();
                        }
                    }, 500);
                }
            } else {
                document.getElementById('loginError').innerText = "密碼錯誤";
            }
        };

        window.showAdminLogin = () => {
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminLoginError').innerText = '';
            bootstrap.Modal.getOrCreateInstance(document.getElementById('adminLoginModal')).show();
        };

        window.performAdminLogin = () => {
            const u = document.getElementById('adminUsername').value;
            const p = document.getElementById('adminPassword').value;
            if (u === 'admin' && p === '31415926') {
                currentUser = {
                    id: 'super_admin_id',
                    name: '管理員',
                    role: 'super_admin'
                };
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                bootstrap.Modal.getOrCreateInstance(document.getElementById('adminLoginModal')).hide();
                updateAuthUI();
            } else {
                document.getElementById('adminLoginError').innerText = "帳號或密碼錯誤";
            }
        };

        window.logout = () => {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            updateAuthUI();
        };

        window.submitChangePassword = async () => {
            if (!currentUser) return;
            const oldPass = document.getElementById('oldPass').value;
            const newPass = document.getElementById('newPass').value;
            const confirmPass = document.getElementById('confirmPass').value;

            if (newPass !== confirmPass) { alert("兩次新密碼輸入不一致"); return; }
            if (newPass.length < 4) { alert("密碼太短，請至少輸入4位數"); return; }

            // Super admin special update
            if (currentUser.role === 'super_admin') {
                alert("超級管理員密碼請由後台修改");
                return;
            }

            // Verify old password by fetching latest data
            const docRef = doc(db, "students", currentUser.id);
            const docSnap = await getDocs(query(studentsRef)); // Inefficient but works, better to use getDoc if possible but we have studentsData
            // Use local check first then overwrite
            const student = studentsData.find(s => s.id === currentUser.id);
            if (student.password !== oldPass) {
                alert("舊密碼錯誤");
                return;
            }

            try {
                await updateDoc(docRef, { password: newPass });
                alert("密碼修改成功！");
                bootstrap.Modal.getOrCreateInstance(document.getElementById('changePasswordModal')).hide();
            } catch (e) {
                console.error(e);
                alert("修改失敗");
            }
        };

        // Initial check
        window.addEventListener('load', () => {
            updateAuthUI();
        });

        // Note: other functions like addStudent, removeStudent are already assigned to window directly above.

        function setGroupBy(mode) {
            currentGroupMode = mode;
            renderAll();
        }

        function getStatusBadge(s) {
            if (s === '實到') return '<span class="badge bg-success">實到</span>';
            if (s === '缺席') return '<span class="badge bg-danger">缺席</span>';
            if (s === '遲到') return '<span class="badge bg-warning text-dark">遲到</span>';
            return `<span class="badge bg-info text-dark">${s}</span>`;
        }
        function filterStudents() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            const cards = document.querySelectorAll('.card'); // Each group/class is in a card

            cards.forEach(card => {
                const rows = card.querySelectorAll('tbody tr');
                let hasVisibleStudent = false;

                rows.forEach(row => {
                    // Check all text in the row (Name, Class, Group, etc.)
                    // This is simpler and robust for both mobile and desktop views
                    if (row.textContent.toLowerCase().includes(query)) {
                        row.style.display = ""; // Reset to default (table-row or grid)
                        hasVisibleStudent = true;
                    } else {
                        row.style.setProperty('display', 'none', 'important'); // Force hide
                    }
                });

                // If searching, hide empty groups.
                if (hasVisibleStudent) {
                    card.parentElement.style.display = "";
                } else {
                    card.parentElement.style.display = "none";
                }
            });
        }

        function getStatusColorClass(s) {
            if (!s || s === '實到') return "text-success border-success bg-white";
            if (s === '缺席') return "text-danger border-danger bg-white";
            if (s === '遲到') return "text-warning border-warning bg-white";
            return "text-secondary border-secondary bg-white";
        }
        function getNameColorClass(s) {
            if (!s || s === '實到') return "text-primary";
            return "text-danger fw-bolder";
        }
        function renderStatusSettings() {
            const canManage = currentUser && ['super_admin', 'general_admin', 'class_admin', 'group_admin'].includes(currentUser.role);

            const addContainer = document.getElementById('addStatusContainer');
            if (addContainer) {
                if (canManage) addContainer.classList.remove('d-none');
                else addContainer.classList.add('d-none');
            }

            document.getElementById('statusListContainer').innerHTML = currentStatuses.map(s => `
                <div class="custom-status-tag border rounded px-2 py-1 bg-light">${s} ${(s !== '實到' && canManage) ? `<span role="button" class="text-danger ms-2 fw-bold" onclick="removeStatusType('${s}')">&times;</span>` : ''}</div>
            `).join('');
        }

        // Enable Drag to Scroll & Wheel to Scroll
        function enableDragScroll(id) {
            const slider = document.getElementById(id);
            let isDown = false;
            let startX;
            let scrollLeft;

            slider.addEventListener('mousedown', (e) => {
                isDown = true;
                slider.classList.add('active');
                startX = e.pageX - slider.offsetLeft;
                scrollLeft = slider.scrollLeft;
            });
            slider.addEventListener('mouseleave', () => {
                isDown = false;
                slider.classList.remove('active');
            });
            slider.addEventListener('mouseup', () => {
                isDown = false;
                slider.classList.remove('active');
            });
            slider.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 2; // Scroll-fast
                slider.scrollLeft = scrollLeft - walk;
            });
            // Convert vertical wheel to horizontal scroll
            slider.addEventListener('wheel', (e) => {
                if (e.deltaY !== 0) {
                    e.preventDefault();
                    slider.scrollLeft += e.deltaY;
                }
            });
        }

        // Initialize scroll features
        enableDragScroll('weekTabs');
        enableDragScroll('sessionTabs');
    </script>
</body>

</html>